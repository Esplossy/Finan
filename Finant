<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0a0a14">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Finan√ßas">
<title>Finan√ßas Pessoais</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0a0a14;--surface:#12121f;--surface2:#1a1a2e;--border:#2a2a45;
  --d5:#f7c948;--d20:#4fd1c5;--danger:#ff6b6b;--success:#6bffb8;
  --sav:#c084fc;--muted:#6b6b8a;--text:#eeeef8;--text2:#a0a0c0;
  --r:14px;--fh:'Syne',sans-serif;--fm:'DM Mono',monospace;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{background:var(--bg);color:var(--text);font-family:var(--fm);min-height:100vh;padding-bottom:80px;overflow-x:hidden}

/* HEADER */
.hdr{position:sticky;top:0;z-index:100;background:rgba(10,10,20,.95);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);padding:12px 18px;display:flex;align-items:center;justify-content:space-between}
.hdr-title{font-family:var(--fh);font-weight:800;font-size:18px}
.hdr-title span{color:var(--d5)}
.month-nav{display:flex;align-items:center;gap:10px}
.btn-mn{background:var(--surface);border:1px solid var(--border);border-radius:8px;color:var(--text);padding:4px 12px;font-family:var(--fm);font-size:13px;cursor:pointer}
.month-lbl{font-family:var(--fh);font-weight:700;font-size:13px;color:var(--text2);min-width:100px;text-align:center}

/* BOTTOM NAV */
.bnav{position:fixed;bottom:0;left:0;right:0;z-index:100;background:rgba(10,10,20,.97);backdrop-filter:blur(20px);border-top:1px solid var(--border);display:flex}
.bnt{flex:1;padding:8px 2px 10px;border:none;background:transparent;color:var(--muted);cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:3px;transition:color .2s;font-family:var(--fm);font-size:9px;letter-spacing:.5px}
.bnt .ico{font-size:20px;line-height:1}
.bnt.active{color:var(--d5)}
.bnt.active .ico{filter:drop-shadow(0 0 6px currentColor)}

/* CONTENT */
#content{padding:0 0 8px}

/* CARDS GRID */
.cards{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:14px 18px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:13px}
.card.full{grid-column:1/-1}
.card.ok{border-color:rgba(107,255,184,.3);background:rgba(107,255,184,.04)}
.card.bad{border-color:rgba(255,107,107,.3);background:rgba(255,107,107,.04)}
.card.sav{border-color:rgba(192,132,252,.3);background:rgba(192,132,252,.04)}
.clbl{font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:4px}
.cval{font-family:var(--fh);font-size:19px;font-weight:700}
.cval.inc{color:var(--success)}.cval.exp{color:var(--danger)}.cval.pos{color:var(--success)}.cval.neg{color:var(--danger)}.cval.sv{color:var(--sav)}.cval.neu{color:var(--text)}
.csub{font-size:10px;color:var(--muted);margin-top:3px}

/* SECTION */
.sec{padding:0 18px;margin-bottom:4px}
.sec-hdr{display:flex;align-items:center;justify-content:space-between;margin:16px 0 9px}
.sec-lbl{font-family:var(--fh);font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted)}
.btn-add{width:28px;height:28px;border-radius:8px;border:1.5px solid var(--border);background:var(--surface);color:var(--text);font-size:17px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
.btn-add:hover{border-color:var(--d5);color:var(--d5)}

/* SUB-TABS */
.stabs{display:flex;gap:8px;padding:12px 18px 0}
.stab{flex:1;padding:9px;border-radius:11px;border:2px solid var(--border);background:transparent;color:var(--muted);font-family:var(--fh);font-weight:700;font-size:13px;cursor:pointer;transition:all .2s}
.stab.s5{border-color:var(--d5);color:var(--d5);background:rgba(247,201,72,.07)}
.stab.s20{border-color:var(--d20);color:var(--d20);background:rgba(79,209,197,.07)}

/* ITEMS */
.ilist{display:flex;flex-direction:column;gap:7px}
.itm{background:var(--surface);border:1px solid var(--border);border-radius:11px;padding:12px 13px;display:flex;align-items:center;gap:10px;transition:all .25s}
.itm.paid{opacity:.55;border-style:dashed}
.itm.paid .iname{text-decoration:line-through}
.iico{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.iico.ii{background:rgba(107,255,184,.1)}.iico.fi{background:rgba(79,209,197,.1)}.iico.vi{background:rgba(247,201,72,.1)}.iico.si{background:rgba(192,132,252,.12)}.iico.vfi{background:rgba(255,107,107,.08)}.iico.gi{background:rgba(255,170,100,.1)}
.iinfo{flex:1;min-width:0}
.iname{font-family:var(--fh);font-weight:600;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.itag{font-size:9px;color:var(--muted);margin-top:2px;display:flex;align-items:center;gap:4px}
.iright{display:flex;align-items:center;gap:6px;flex-shrink:0}
.iamt{font-weight:500;font-size:13px}
.iamt.pos{color:var(--success)}.iamt.neg{color:var(--danger)}.iamt.sv{color:var(--sav)}.iamt.pend{color:var(--muted);font-size:11px;font-style:italic}
.iamt.paid-real{color:var(--success);font-size:11px}

.btn-pay{width:26px;height:26px;border-radius:50%;border:2px solid var(--border);background:transparent;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .2s;font-size:12px;color:transparent}
.btn-pay:hover{border-color:var(--success);color:var(--success)}
.btn-pay.done{border-color:var(--success);background:rgba(107,255,184,.15);color:var(--success)}
.btn-pen{width:24px;height:24px;border-radius:7px;border:none;background:rgba(79,209,197,.1);color:var(--d20);font-size:11px;cursor:pointer;display:flex;align-items:center;justify-content:center;opacity:.7;transition:all .15s}
.btn-pen:hover{opacity:1}
.btn-del{width:24px;height:24px;border-radius:7px;border:none;background:rgba(255,107,107,.1);color:var(--danger);font-size:11px;cursor:pointer;display:flex;align-items:center;justify-content:center;opacity:.4;transition:all .15s}
.btn-del:hover{opacity:1}
.empty{text-align:center;padding:18px;color:var(--muted);font-size:11px;border:1.5px dashed var(--border);border-radius:11px}

/* PROGRESS BAR */
.pbar{margin:0 18px 4px}
.pbar-bg{background:var(--surface);border:1px solid rgba(192,132,252,.25);border-radius:12px;padding:13px}
.pbar-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.pbar-title{font-family:var(--fh);font-weight:700;font-size:12px}
.pbar-pct{font-size:11px;color:var(--muted)}
.track{height:7px;background:var(--border);border-radius:99px;overflow:hidden}
.fill{height:100%;border-radius:99px;transition:width .5s ease}
.fill-sav{background:linear-gradient(90deg,var(--sav),#a855f7)}
.fill-ok{background:linear-gradient(90deg,var(--success),#22d3ee)}
.fill-bad{background:linear-gradient(90deg,var(--danger),#f97316)}
.pbar-detail{display:flex;justify-content:space-between;margin-top:7px;font-size:10px;color:var(--muted)}

/* GASTOS CATS */
.cat-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:0 18px;margin-bottom:4px}
.cat-card{background:var(--surface);border:1px solid var(--border);border-radius:11px;padding:11px}
.cat-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.cat-name{font-family:var(--fh);font-weight:700;font-size:12px}
.cat-amt{font-size:11px;color:var(--d5)}
.cat-track{height:5px;background:var(--border);border-radius:99px;overflow:hidden}
.cat-fill{height:100%;border-radius:99px;background:var(--d5);transition:width .4s}

/* DASH */
.dash-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:14px 18px}
.dash-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:13px}
.dash-card.full{grid-column:1/-1}
.insight{background:var(--surface);border-left:3px solid var(--d5);border-radius:0 11px 11px 0;padding:10px 13px;margin:0 18px 8px;font-size:12px;line-height:1.5}
.insight.warn{border-color:var(--danger)}
.insight.good{border-color:var(--success)}

/* CAIXINHA */
.cx-bal{margin:14px 18px;background:var(--surface);border:2px solid rgba(107,255,184,.3);border-radius:var(--r);padding:18px;text-align:center}
.cx-lbl{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:6px}
.cx-val{font-family:var(--fh);font-size:36px;font-weight:800}
.cx-btns{display:flex;gap:10px;padding:0 18px 14px}
.cx-btn{flex:1;padding:12px;border-radius:12px;border:none;font-family:var(--fh);font-weight:700;font-size:14px;cursor:pointer;transition:all .2s}
.cx-in{background:rgba(107,255,184,.15);color:var(--success);border:1.5px solid rgba(107,255,184,.3)}
.cx-out{background:rgba(255,107,107,.12);color:var(--danger);border:1.5px solid rgba(255,107,107,.25)}
.cx-btn:hover{transform:scale(.97)}

/* DIVIDAS */
.div-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:14px;margin:0 18px 10px}
.div-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.div-name{font-family:var(--fh);font-weight:700;font-size:14px}
.div-who{font-size:10px;color:var(--muted);margin-top:1px}
.div-right{text-align:right}
.div-rest{font-family:var(--fh);font-weight:700;font-size:14px;color:var(--danger)}
.div-total{font-size:10px;color:var(--muted)}
.div-months{font-size:10px;color:var(--d5);margin-top:2px}
.div-actions{display:flex;gap:7px;margin-top:10px}
.div-pay-btn{flex:1;padding:8px;border-radius:9px;border:none;background:rgba(107,255,184,.12);color:var(--success);font-family:var(--fh);font-weight:700;font-size:12px;cursor:pointer;border:1.5px solid rgba(107,255,184,.25)}
.div-del-btn{width:32px;padding:8px;border-radius:9px;border:none;background:rgba(255,107,107,.1);color:var(--danger);cursor:pointer;font-size:13px}

/* TAG */
.tag{display:inline-block;padding:1px 6px;border-radius:20px;font-size:8px;font-weight:500;letter-spacing:.5px}
.ti{background:rgba(107,255,184,.1);color:var(--success)}.tf{background:rgba(79,209,197,.12);color:var(--d20)}.tv{background:rgba(247,201,72,.1);color:var(--d5)}.ts{background:rgba(192,132,252,.12);color:var(--sav)}.tvf{background:rgba(255,107,107,.1);color:var(--danger)}

/* MODAL */
.mbg{display:none;position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.8);backdrop-filter:blur(10px);align-items:flex-end;justify-content:center}
.mbg.open{display:flex}
.modal{background:var(--surface2);border:1px solid var(--border);border-radius:22px 22px 0 0;padding:18px 18px 44px;width:100%;max-width:520px;animation:sup .28s cubic-bezier(.34,1.56,.64,1);max-height:88vh;overflow-y:auto}
@keyframes sup{from{transform:translateY(100%)}to{transform:translateY(0)}}
.mhandle{width:36px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 16px}
.mtitle{font-family:var(--fh);font-weight:800;font-size:17px;margin-bottom:14px}
.field{margin-bottom:12px}
.field label{display:block;font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:4px}
.field input,.field select,.field textarea{width:100%;padding:10px 12px;background:var(--surface);border:1.5px solid var(--border);border-radius:9px;color:var(--text);font-family:var(--fm);font-size:14px;outline:none;transition:border-color .2s}
.field input:focus,.field select:focus,.field textarea:focus{border-color:var(--d5)}
.field select option{background:var(--surface2)}
.ibox{background:rgba(247,201,72,.07);border:1px solid rgba(247,201,72,.2);border-radius:9px;padding:9px 12px;font-size:11px;color:var(--d5);margin-bottom:12px;line-height:1.5}
.btn-sv{width:100%;padding:12px;border-radius:11px;border:none;background:var(--d5);color:#0a0a14;font-family:var(--fh);font-weight:800;font-size:15px;cursor:pointer;margin-top:5px;transition:all .2s}
.btn-sv:hover{transform:scale(.98);opacity:.9}
.btn-cv{width:100%;padding:10px;border-radius:11px;border:1.5px solid var(--border);background:transparent;color:var(--muted);font-family:var(--fh);font-weight:600;font-size:13px;cursor:pointer;margin-top:6px}
.btn-row{display:flex;gap:8px;margin-top:5px}
.btn-row .btn-sv,.btn-row .btn-cv{margin-top:0}

/* period title */
.ptitle{font-family:var(--fh);font-size:22px;font-weight:800;letter-spacing:-1px;padding:16px 18px 0}
.ptitle .hl{color:var(--d5)}
.ptitle .hl20{color:var(--d20)}

/* Debt payoff badge */
.payoff-badge{display:inline-block;padding:2px 8px;border-radius:20px;font-size:9px;font-weight:500;background:rgba(247,201,72,.1);color:var(--d5);margin-top:4px}

.page{display:none}.page.active{display:block}

/* no data */
.nodebts{text-align:center;padding:40px 20px;color:var(--muted)}
.nodebts .big{font-size:40px;margin-bottom:10px}
.nodebts p{font-size:12px;line-height:1.6}

/* Alerta saldo */
.alert-bar{margin:10px 18px 0;padding:10px 13px;border-radius:10px;font-size:11px;line-height:1.5;display:flex;align-items:center;gap:8px}
.alert-bar.red{background:rgba(255,107,107,.1);border:1px solid rgba(255,107,107,.25);color:var(--danger)}
.alert-bar.green{background:rgba(107,255,184,.08);border:1px solid rgba(107,255,184,.2);color:var(--success)}
.alert-bar.yellow{background:rgba(247,201,72,.08);border:1px solid rgba(247,201,72,.2);color:var(--d5)}

/* Progress ring for dashboard */
.ring-wrap{display:flex;align-items:center;gap:12px}
.ring{width:48px;height:48px;flex-shrink:0}
.ring-info{flex:1}

/* Gasto quick log */
.gasto-itm{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:10px 13px;display:flex;align-items:center;gap:10px;margin-bottom:7px}
.gasto-cat{font-size:18px;flex-shrink:0}
.gasto-info{flex:1;min-width:0}
.gasto-desc{font-family:var(--fh);font-weight:600;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.gasto-dt{font-size:9px;color:var(--muted);margin-top:1px}
.gasto-amt{font-size:13px;font-weight:500;color:var(--danger);flex-shrink:0}

/* Separador */
.sep{height:1px;background:var(--border);margin:6px 18px;opacity:.4}

/* Chip */
.chip{display:inline-block;padding:3px 9px;border-radius:20px;font-size:10px;cursor:pointer;border:1.5px solid var(--border);color:var(--muted);font-family:var(--fh);font-weight:600;transition:all .15s;margin:3px}
.chip.sel{border-color:var(--d5);color:var(--d5);background:rgba(247,201,72,.08)}
.chips-wrap{display:flex;flex-wrap:wrap;margin-bottom:8px}

.fab{position:fixed;right:18px;bottom:90px;width:52px;height:52px;border-radius:50%;border:none;background:var(--d5);color:#0a0a14;font-size:24px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 20px rgba(247,201,72,.35);z-index:90;transition:all .2s}
.fab:hover{transform:scale(.95)}
</style>
</head>
<body>

<div class="hdr">
  <div class="hdr-title">üí∏ Meu <span>Caixa</span></div>
  <button onclick="openSettings()" style="background:transparent;border:1px solid var(--border);border-radius:8px;padding:5px 10px;color:var(--muted);cursor:pointer;font-size:14px" title="Configura√ß√µes">‚öôÔ∏è</button>
  <div class="month-nav">
    <button class="btn-mn" onclick="chM(-1)">‚óÄ</button>
    <div class="month-lbl" id="mlbl">‚Äî</div>
    <button class="btn-mn" onclick="chM(1)">‚ñ∂</button>
  </div>
</div>

<div id="content">
  <div id="pg-plano" class="page active"></div>
  <div id="pg-gastos" class="page"></div>
  <div id="pg-caixinha" class="page"></div>
  <div id="pg-dividas" class="page"></div>
  <div id="pg-dash" class="page"></div>
</div>

<button class="fab" id="fabBtn" onclick="fabAction()">Ôºã</button>

<nav class="bnav">
  <button class="bnt active" onclick="setPage('plano')" id="bnav-plano"><span class="ico">üìÖ</span>Plano</button>
  <button class="bnt" onclick="setPage('gastos')" id="bnav-gastos"><span class="ico">üí∏</span>Gastos</button>
  <button class="bnt" onclick="setPage('caixinha')" id="bnav-caixinha"><span class="ico">üí∞</span>Caixinha</button>
  <button class="bnt" onclick="setPage('dividas')" id="bnav-dividas"><span class="ico">üìã</span>D√≠vidas</button>
  <button class="bnt" onclick="setPage('dash')" id="bnav-dash"><span class="ico">üìä</span>Dash</button>
</nav>

<!-- MODAL: Add Entry -->
<div class="mbg" id="mEntry" onclick="closeBg('mEntry')">
<div class="modal">
  <div class="mhandle"></div>
  <div class="mtitle" id="mEntryTitle">Novo Lan√ßamento</div>
  <div id="mEntryInfo" class="ibox" style="display:none"></div>
  <div class="field"><label>Descri√ß√£o</label><input type="text" id="eName" placeholder="Ex: Cart√£o, Sal√°rio..." autocomplete="off"></div>
  <div class="field" id="eAmtF"><label>Valor (R$)</label><input type="number" id="eAmt" placeholder="0,00" step="0.01" min="0"></div>
  <div class="field"><label>Categoria</label>
    <select id="eType" onchange="onEType()">
      <option value="income">üí∞ Entrada / Sal√°rio</option>
      <option value="fixed" selected>üîí Despesa Fixa</option>
      <option value="variable">üìå Despesa Pontual</option>
      <option value="variable_fixed">‚ö° Fixa de Valor Vari√°vel</option>
    </select>
  </div>
  <div class="field"><label>Dia de Vencimento</label>
    <select id="eDay"><option value="5">Dia 05</option><option value="20">Dia 20</option></select>
  </div>
  <div class="field" id="eRecF"><label>Recorr√™ncia</label>
    <select id="eRec"><option value="monthly">Todo m√™s</option><option value="once">Apenas este m√™s</option></select>
  </div>
  <button class="btn-sv" onclick="saveEntry()">Salvar</button>
  <button class="btn-cv" onclick="closeM('mEntry')">Cancelar</button>
</div></div>

<!-- MODAL: Set variable amount -->
<div class="mbg" id="mVal" onclick="closeBg('mVal')">
<div class="modal">
  <div class="mhandle"></div>
  <div class="mtitle" id="mValTitle">Valor deste M√™s</div>
  <div class="field"><label>Valor (R$)</label><input type="number" id="vAmt" placeholder="0,00" step="0.01" min="0"></div>
  <button class="btn-sv" onclick="saveVAmt()">Salvar</button>
  <button class="btn-cv" onclick="closeM('mVal')">Cancelar</button>
</div></div>

<!-- MODAL: Mark as paid -->
<div class="mbg" id="mPay" onclick="closeBg('mPay')">
<div class="modal">
  <div class="mhandle"></div>
  <div class="mtitle" id="mPayTitle">Marcar como Pago</div>
  <div class="ibox" id="mPayInfo"></div>
  <div class="field"><label>Valor pago (R$)</label><input type="number" id="pAmt" step="0.01" min="0"></div>
  <div class="btn-row">
    <button class="btn-sv" onclick="confirmPay()">‚úì Confirmar</button>
    <button class="btn-cv" style="border-color:var(--danger);color:var(--danger)" onclick="unpay()">Desfazer</button>
  </div>
  <button class="btn-cv" onclick="closeM('mPay')">Cancelar</button>
</div></div>

<!-- MODAL: Gasto r√°pido -->
<div class="mbg" id="mGasto" onclick="closeBg('mGasto')">
<div class="modal">
  <div class="mhandle"></div>
  <div class="mtitle">Gasto do Dia a Dia</div>
  <div class="field"><label>Descri√ß√£o</label><input type="text" id="gDesc" placeholder="Ex: Mercado, iFood..." autocomplete="off"></div>
  <div class="field"><label>Valor (R$)</label><input type="number" id="gAmt" placeholder="0,00" step="0.01" min="0"></div>
  <div class="field"><label>Categoria</label>
    <select id="gCat">
      <option>üõí Mercado</option><option>‚õΩ Combust√≠vel</option><option>üíä Farm√°cia</option>
      <option>üçî Alimenta√ß√£o</option><option>üéÆ Lazer</option><option>üëï Roupas</option>
      <option>üè† Casa</option><option>üöå Transporte</option><option>üì± Telefone</option><option>üí° Outros</option>
    </select>
  </div>
  <button class="btn-sv" onclick="saveGasto()">Salvar</button>
  <button class="btn-cv" onclick="closeM('mGasto')">Cancelar</button>
</div></div>

<!-- MODAL: D√≠vida -->
<div class="mbg" id="mDiv" onclick="closeBg('mDiv')">
<div class="modal">
  <div class="mhandle"></div>
  <div class="mtitle">Nova D√≠vida</div>
  <div class="field"><label>Nome da D√≠vida</label><input type="text" id="dName" placeholder="Ex: Empr√©stimo, Cart√£o..." autocomplete="off"></div>
  <div class="field"><label>Para quem / Onde</label><input type="text" id="dWho" placeholder="Ex: Sogra, Banco..." autocomplete="off"></div>
  <div class="field">
    <label>Tipo de D√≠vida</label>
    <select id="dKind" onchange="onDKind()">
      <option value="parcelada">üì¶ Parcelada (X parcelas)</option>
      <option value="aberta">üí≥ Em aberto (sem prazo fixo)</option>
    </select>
  </div>
  <div id="dParcelaFields">
    <div class="field"><label>Valor Total (R$)</label><input type="number" id="dTotal" placeholder="0,00" step="0.01" min="0" oninput="calcParcela()"></div>
    <div style="display:flex;gap:8px">
      <div class="field" style="flex:1"><label>N¬∫ de Parcelas</label><input type="number" id="dNParcelas" placeholder="Ex: 12" min="1" step="1" oninput="calcParcela()"></div>
      <div class="field" style="flex:1"><label>Parcelas Pagas</label><input type="number" id="dPagas" placeholder="0" min="0" step="1" value="0" oninput="calcParcela()"></div>
    </div>
    <div class="field"><label>Valor da Parcela (R$)</label><input type="number" id="dMonthly" placeholder="Calculado automaticamente" step="0.01" min="0" oninput="calcParcelaRev()"></div>
    <div id="dParcelaInfo" style="font-size:11px;color:var(--muted);margin:-8px 0 10px;padding:8px 12px;background:var(--surface);border-radius:8px;display:none"></div>
  </div>
  <div id="dAbertaFields" style="display:none">
    <div class="field"><label>Valor Total (R$)</label><input type="number" id="dTotalAberta" placeholder="0,00" step="0.01" min="0"></div>
    <div class="field"><label>J√° paguei (R$)</label><input type="number" id="dPaid" placeholder="0,00" step="0.01" min="0" value="0"></div>
    <div class="field"><label>Quanto pagar por m√™s (R$)</label><input type="number" id="dMonthlyAberta" placeholder="0,00" step="0.01" min="0"></div>
  </div>
  <div class="field"><label>Dia de Cobran√ßa</label>
    <select id="dDay"><option value="5">Dia 05</option><option value="20">Dia 20</option></select>
  </div>
  <div class="field"><label>Observa√ß√£o (opcional)</label><input type="text" id="dNote" placeholder="Ex: Sogra, Nubank..." autocomplete="off"></div>
  <button class="btn-sv" onclick="saveDiv()">Salvar D√≠vida</button>
  <button class="btn-cv" onclick="closeM('mDiv')">Cancelar</button>
</div></div>

<!-- MODAL: Pagar d√≠vida -->
<div class="mbg" id="mDivPay" onclick="closeBg('mDivPay')">
<div class="modal">
  <div class="mhandle"></div>
  <div class="mtitle" id="mDivPayTitle">Registrar Pagamento</div>
  <div class="field"><label>Valor pago (R$)</label><input type="number" id="dpAmt" step="0.01" min="0"></div>
  <div class="field"><label>Observa√ß√£o</label><input type="text" id="dpNote" placeholder="opcional" autocomplete="off"></div>
  <button class="btn-sv" onclick="saveDivPay()">Confirmar</button>
  <button class="btn-cv" onclick="closeM('mDivPay')">Cancelar</button>
</div></div>

<!-- MODAL: Caixinha -->
<div class="mbg" id="mCx" onclick="closeBg('mCx')">
<div class="modal">
  <div class="mhandle"></div>
  <div class="mtitle" id="mCxTitle">Caixinha</div>
  <div class="field"><label>Descri√ß√£o</label><input type="text" id="cxDesc" placeholder="Ex: Sobra do m√™s, Mercado..." autocomplete="off"></div>
  <div class="field"><label>Valor (R$)</label><input type="number" id="cxAmt" placeholder="0,00" step="0.01" min="0"></div>
  <button class="btn-sv" id="cxSvBtn" onclick="saveCx()">Salvar</button>
  <button class="btn-cv" onclick="closeM('mCx')">Cancelar</button>
</div></div>


<!-- MODAL: Settings -->
<div class="mbg" id="mSettings" onclick="closeBg('mSettings')">
<div class="modal">
  <div class="mhandle"></div>
  <div class="mtitle">‚öôÔ∏è Configura√ß√µes</div>
  <div style="background:rgba(247,201,72,.07);border:1px solid rgba(247,201,72,.2);border-radius:10px;padding:12px;font-size:11px;color:var(--d5);margin-bottom:14px;line-height:1.7">
    <strong>Como conectar ao Google Sheets:</strong><br>
    1. Abra sua planilha no Google Sheets<br>
    2. Menu: <strong>Extens√µes ‚Üí Apps Script</strong><br>
    3. Cole o c√≥digo do arquivo <code>.gs</code> fornecido<br>
    4. Clique em <strong>Implantar ‚Üí Nova implanta√ß√£o</strong><br>
    5. Tipo: <strong>Web App</strong> ¬∑ Acesso: <strong>Qualquer pessoa</strong><br>
    6. Copie a URL gerada e cole abaixo
  </div>
  <div class="field">
    <label>URL do Apps Script</label>
    <input type="url" id="scriptUrl" placeholder="https://script.google.com/macros/s/..." autocomplete="off">
  </div>
  <div class="field">
    <label>Nome da Planilha (opcional)</label>
    <input type="text" id="sheetName" placeholder="Ex: Finan√ßas 2026" autocomplete="off">
  </div>
  <button class="btn-sv" onclick="saveSettings()">Salvar</button>
  <button class="btn-cv" onclick="closeM('mSettings')">Cancelar</button>
</div></div>

<!-- MODAL: Sync resultado -->
<div class="mbg" id="mSyncResult" onclick="closeBg('mSyncResult')">
<div class="modal">
  <div class="mhandle"></div>
  <div class="mtitle" id="syncResultTitle">Resultado</div>
  <div id="syncResultMsg" style="font-size:13px;line-height:1.6;color:var(--text2);margin-bottom:14px"></div>
  <button class="btn-cv" onclick="closeM('mSyncResult')">Fechar</button>
</div></div>

<script>
// ============ CONSTANTS ============
const MF=['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
const MS=['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
const CAT_ICONS={'üõí Mercado':'üõí','‚õΩ Combust√≠vel':'‚õΩ','üíä Farm√°cia':'üíä','üçî Alimenta√ß√£o':'üçî','üéÆ Lazer':'üéÆ','üëï Roupas':'üëï','üè† Casa':'üè†','üöå Transporte':'üöå','üì± Telefone':'üì±','üí° Outros':'üí°'};

// ============ STATE ============
let S = loadState();
let curPage = 'plano';
let subDay = 5;
let cm = 2; // Mar√ßo
let cy = 2026;
let payingId = null, valId = null, divPayId = null, cxType = null;

function loadState() {
  const s = JSON.parse(localStorage.getItem('fc_v4')||'null');
  if (s) {
    if(!s.mv) s.mv={};
    if(!s.payments) s.payments={};
    if(!s.transferencias) s.transferencias={};
    // Migration: fix √Ågua to day 5
    s.entries.forEach(e=>{ if(e.name==='√Ågua' && e.day===20) e.day=5; });
    localStorage.setItem('fc_v4', JSON.stringify(s));
    return s;
  }
  const ns = {entries:[],nextId:1,mv:{},payments:{},debts:[],nextDId:1,debtPays:[],nextDPId:1,caixinha:[],nextCxId:1,gastos:[],nextGId:1,transferencias:{}};
  initDefs(ns);
  return ns;
}

function initDefs(s) {
  const defs = [
    {name:'Sal√°rio (eu)',  amount:1500, type:'income', day:5,  rec:'monthly'},
    {name:'Sal√°rio (ela)', amount:1800, type:'income', day:5,  rec:'monthly'},
    {name:'Cart√£o',        amount:1240, type:'fixed',  day:5,  rec:'monthly'},
    {name:'Sal√°rio (eu)',  amount:1050, type:'income', day:20, rec:'monthly'},
    {name:'Luz',           amount:0,   type:'variable_fixed', day:20, rec:'monthly'},
    {name:'√Ågua',          amount:0,   type:'variable_fixed', day:5,  rec:'monthly'},
  ];
  defs.forEach(d => s.entries.push({id:s.nextId++,...d}));
}

function persist() { localStorage.setItem('fc_v4', JSON.stringify(S)); }

// ============ HELPERS ============
function pkey(id) { return `${id}-${cy}-${cm}`; }
function mkey(id) { return `${id}-${cy}-${cm}`; }

function getAmt(e) {
  if (e.type==='variable_fixed') { const v=S.mv[mkey(e.id)]; return v!==undefined?v:null; }
  return e.amount;
}

function isPaid(id) { return !!(S.payments[pkey(id)]?.paid); }
function paidAmt(id) { return S.payments[pkey(id)]?.amount||0; }

function periodEntries(day) {
  return S.entries.filter(e=>{
    if(e.day!=day)return false;
    if(e.rec==='monthly'||e.type==='variable_fixed')return true;
    if(e.rec==='once')return e.month===cm&&e.year===cy;
    return false;
  });
}

function sumT(arr, types) {
  return arr.filter(e=>types.includes(e.type)).reduce((s,e)=>s+(getAmt(e)||0),0);
}

function sumPaid(arr, types) {
  return arr.filter(e=>types.includes(e.type)&&isPaid(e.id)).reduce((s,e)=>s+paidAmt(e.id),0);
}

function fmt(v,sign=false) {
  const abs = Math.abs(v).toFixed(2).replace('.',',').replace(/\B(?=(\d{3})+(?!\d))/g,'.');
  if(sign&&v<0) return '-R$ '+abs;
  return 'R$ '+abs;
}

function fmtDate(iso) {
  const d=new Date(iso); return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}`;
}

function debtRemaining(d) {
  const paid = S.debtPays.filter(p=>p.dId===d.id).reduce((s,p)=>s+p.amt,0) + (d.initialPaid||0);
  return Math.max(0, d.total - paid);
}

function debtPaidTotal(d) {
  return S.debtPays.filter(p=>p.dId===d.id).reduce((s,p)=>s+p.amt,0) + (d.initialPaid||0);
}

function cxBalance() {
  return S.caixinha.reduce((s,t)=>s+(t.type==='in'?t.amt:-t.amt),0);
}

// Reserva do Dia 05 para o Dia 20
const RESERVA_META = 800;
function getReservaKey() { return `reserva-${cy}-${cm}`; }
function getReserva() { return S.reservas?.[getReservaKey()]??null; }
function setReserva(v) { if(!S.reservas)S.reservas={}; S.reservas[getReservaKey()]=v; }

// Caixinha do m√™s atual
function cxMonthNet() {
  const txs = S.caixinha.filter(t=>t.month===cm&&t.year===cy);
  return txs.reduce((s,t)=>s+(t.type==='in'?t.amt:-t.amt),0);
}

function monthGastos() {
  return S.gastos.filter(g=>g.month===cm&&g.year===cy);
}

// ============ RENDER: PLANO ============
function getTransfKey() { return `transf-${cy}-${cm}`; }
function getTransf()    { return S.transferencias?.[getTransfKey()] ?? null; }
function setTransf(v)   { if(!S.transferencias) S.transferencias={}; S.transferencias[getTransfKey()]=v; }

function renderPlano() {
  const pg  = document.getElementById('pg-plano');
  const day = subDay;
  const ents    = periodEntries(day);
  const incomes = ents.filter(e=>e.type==='income');
  const fixeds  = ents.filter(e=>e.type==='fixed');
  const vfixed  = ents.filter(e=>e.type==='variable_fixed');
  const vars    = ents.filter(e=>e.type==='variable');

  const totalIn  = sumT(ents,['income']);
  const totalOut = sumT(ents,['fixed','variable','variable_fixed']);

  const transf = getTransf() ?? 0; // quanto guardaram do dia 05 pro dia 20

  // Dia 05: saldo = sal√°rios - contas - transfer√™ncia
  // Dia 20: saldo = sal√°rio - contas + transfer√™ncia recebida
  const bal05real = totalIn - totalOut - (day===5 ? transf : 0);
  const bal20real = (totalIn + (day===20 ? transf : 0)) - totalOut;
  const bal = day===5 ? bal05real : bal20real;

  const remaining = ents.filter(e=>e.type!=='income'&&!isPaid(e.id)).reduce((s,e)=>s+(getAmt(e)||0),0);
  const countPend = ents.filter(e=>e.type!=='income'&&!isPaid(e.id)).length;

  const alertHTML = bal<0
    ? `<div class="alert-bar red">‚ö†Ô∏è Per√≠odo no vermelho em ${fmt(Math.abs(bal))}</div>`
    : bal < 200
    ? `<div class="alert-bar yellow">‚ö° Saldo apertado ‚Äî sobra apenas ${fmt(bal)}</div>`
    : `<div class="alert-bar green">‚úì Sobra ${fmt(bal)} ap√≥s pagar tudo</div>`;

  // Widget de transfer√™ncia ‚Äî aparece nos dois dias
  const transfColor = transf > 0 ? 'rgba(192,132,252,.4)' : 'var(--border)';
  const transfWidget = `
    <div style="margin:12px 18px 0">
      <div style="background:var(--surface);border:2px solid ${transfColor};border-radius:14px;padding:14px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-family:var(--fh);font-weight:700;font-size:13px;color:${transf>0?'var(--sav)':'var(--muted)'}">
              ${day===5 ? 'üí∏ Guardado pro Dia 20' : 'üí∞ Recebido do Dia 05'}
            </div>
            <div style="font-size:10px;color:var(--muted);margin-top:2px">
              ${day===5 ? 'Sai do Dia 05 e entra no Dia 20' : 'Transferido do Dia 05'}
            </div>
          </div>
          <div style="display:flex;align-items:center;gap:8px">
            <div style="font-family:var(--fh);font-weight:800;font-size:20px;color:${transf>0?'var(--sav)':'var(--muted)'}">
              ${transf > 0 ? fmt(transf) : '‚Äî'}
            </div>
            <button onclick="openTransf()" style="padding:7px 12px;border-radius:9px;border:none;background:${transf>0?'rgba(192,132,252,.15)':'var(--d5)'};color:${transf>0?'var(--sav)':'#0a0a14'};font-family:var(--fh);font-weight:700;font-size:12px;cursor:pointer">
              ${transf > 0 ? '‚úé' : '+ Definir'}
            </button>
            ${transf>0?`<button onclick="clearTransf()" style="width:28px;height:28px;border-radius:8px;border:none;background:rgba(255,107,107,.1);color:var(--danger);cursor:pointer;font-size:12px">‚úï</button>`:''}
          </div>
        </div>
      </div>
    </div>`;

  pg.innerHTML = `
    <div class="stabs">
      <button class="stab ${day===5?'s5':''}" onclick="setSubDay(5)">DIA 05</button>
      <button class="stab ${day===20?'s20':''}" onclick="setSubDay(20)">DIA 20</button>
    </div>
    ${alertHTML}
    <div class="cards">
      <div class="card">
        <div class="clbl">Sal√°rios</div>
        <div class="cval inc">${fmt(totalIn)}</div>
        <div class="csub">${incomes.map(e=>e.name.replace('Sal√°rio ','')).join(' + ')}</div>
      </div>
      <div class="card">
        <div class="clbl">Contas</div>
        <div class="cval exp">${fmt(totalOut)}</div>
      </div>
      ${transf>0 ? `
      <div class="card" style="border-color:rgba(192,132,252,.35);background:rgba(192,132,252,.05)">
        <div class="clbl" style="color:var(--sav)">${day===5?'üí∏ Transferido ao Dia 20':'üí∞ Recebido do Dia 05'}</div>
        <div class="cval sav">${day===5?'-':'+'}${fmt(transf)}</div>
      </div>` : ''}
      <div class="card full ${bal>=0?'ok':'bad'}">
        <div class="clbl">${day===5?'Saldo do Dia 05':'Saldo Final do Dia 20'}</div>
        <div class="cval ${bal>=0?'pos':'neg'}">${fmt(bal,true)}</div>
      </div>
      ${countPend>0?`
      <div class="card">
        <div class="clbl">A Pagar Ainda</div>
        <div class="cval exp">${fmt(remaining)}</div>
        <div class="csub">${countPend} conta(s) pendente(s)</div>
      </div>`:''}
    </div>
    ${transfWidget}
    <div class="sec">
      <div class="sec-hdr"><div class="sec-lbl">üîí Despesas Fixas</div><button class="btn-add" onclick="openEntry('fixed',${day})">+</button></div>
      <div class="ilist">${fixeds.map(itemH).join('')||emptyH()}</div>
    </div>
    ${vfixed.length?`
    <div class="sec">
      <div class="sec-hdr"><div class="sec-lbl">‚ö° Valor Vari√°vel</div><button class="btn-add" onclick="openEntry('variable_fixed',${day})">+</button></div>
      <div class="ilist">${vfixed.map(itemH).join('')}</div>
    </div>`:''}
    <div class="sec">
      <div class="sec-hdr"><div class="sec-lbl">üìå Pontuais</div><button class="btn-add" onclick="openEntry('variable',${day})">+</button></div>
      <div class="ilist">${vars.map(itemH).join('')||emptyH()}</div>
    </div>
  `;
}

function openTransf() {
  const cur = getTransf();
  const div = document.createElement('div');
  div.id = 'mTransfInline';
  div.className = 'mbg open';
  div.innerHTML = `
    <div class="modal">
      <div class="mhandle"></div>
      <div class="mtitle">üí∏ Quanto guardou pro Dia 20?</div>
      <div class="ibox">Coloque o valor que voc√™ conseguiu separar do Dia 05 para o Dia 20. Ele vai ser descontado do saldo do Dia 05 e adicionado como entrada no Dia 20.</div>
      <div class="field"><label>Valor (R$)</label><input type="number" id="tVal" placeholder="0,00" step="0.01" min="0" value="${cur!==null?cur:''}"></div>
      <div style="display:flex;gap:8px;margin-top:5px">
        <button class="btn-sv" onclick="saveTransf()">Salvar</button>
        <button class="btn-cv" style="margin-top:0" onclick="document.getElementById('mTransfInline').remove()">Cancelar</button>
      </div>
    </div>`;
  div.addEventListener('click', e=>{ if(e.target===div) div.remove(); });
  document.body.appendChild(div);
  setTimeout(()=>document.getElementById('tVal').focus(),300);
}

function saveTransf() {
  const v = parseFloat(document.getElementById('tVal').value);
  if(isNaN(v)||v<0) return;
  setTransf(v); persist();
  document.getElementById('mTransfInline').remove();
  render();
}

function clearTransf() {
  if(!confirm('Limpar a transfer√™ncia deste m√™s?')) return;
  setTransf(null); persist(); render();
}

function itemH(e) {
  const icons={income:'üí∞',fixed:'üîí',variable:'üìå',variable_fixed:'‚ö°',saving:'üéØ'};
  const icls={income:'ii',fixed:'fi',variable:'vi',variable_fixed:'vfi',saving:'si'};
  const tcls={income:'ti',fixed:'tf',variable:'tv',variable_fixed:'tvf',saving:'ts'};
  const ttxt={income:'ENTRADA',fixed:'FIXA',variable:'PONTUAL',variable_fixed:'VAR',saving:'RESERVA'};
  const isInc=e.type==='income';
  const paid=isPaid(e.id);
  const planned=getAmt(e);

  let amtH='';
  if(e.type==='variable_fixed') {
    if(planned===null) amtH=`<div class="iamt pend">Definir</div>`;
    else if(paid) amtH=`<div class="iamt paid-real">‚úì ${fmt(paidAmt(e.id))}</div>`;
    else amtH=`<div class="iamt neg">${fmt(planned)}</div>`;
  } else if(paid) {
    const pa=paidAmt(e.id);
    amtH=`<div class="iamt ${isInc?'pos':'paid-real'}">‚úì ${fmt(pa)}</div>`;
  } else {
    amtH=`<div class="iamt ${isInc?'pos':'neg'}">${isInc?'+':'-'}${fmt(planned||0)}</div>`;
  }

  const penBtn=e.type==='variable_fixed'?`<button class="btn-pen" onclick="openVAmt(${e.id},'${e.name}')">‚úé</button>`:'';
  const payBtn=(e.type!=='saving'&&e.type!=='income')?`<button class="btn-pay ${paid?'done':''}" onclick="openPay(${e.id},'${e.name}',${planned||0})">${paid?'‚úì':''}</button>`:'';

  return `
  <div class="itm ${paid?'paid':''}">
    <div class="iico ${icls[e.type]}">${icons[e.type]}</div>
    <div class="iinfo">
      <div class="iname">${e.name}</div>
      <div class="itag">
        <span class="tag ${tcls[e.type]}">${ttxt[e.type]}</span>
        ${e.rec==='monthly'||e.type==='variable_fixed'?'<span style="color:var(--muted);font-size:8px">‚Üª</span>':''}
        ${paid&&paidAmt(e.id)!==(planned||0)?`<span style="color:var(--d5);font-size:8px">planejado ${fmt(planned||0)}</span>`:''}
      </div>
    </div>
    <div class="iright">
      ${amtH}
      ${penBtn}
      ${payBtn}
      <button class="btn-del" onclick="delEntry(${e.id})">‚úï</button>
    </div>
  </div>`;
}

function emptyH() { return `<div class="empty">Use + para adicionar</div>`; }

// ============ RENDER: GASTOS ============
function renderGastos() {
  const pg = document.getElementById('pg-gastos');
  const gs = monthGastos();
  const total = gs.reduce((s,g)=>s+g.amt,0);

  // group by cat
  const byCat = {};
  gs.forEach(g=>{ if(!byCat[g.cat])byCat[g.cat]=0; byCat[g.cat]+=g.amt; });
  const catLimit = 2000; // soft limit total gastos
  const pct = Math.min(100, Math.round(total/catLimit*100));
  const pctColor = pct>90?'fill-bad':pct>70?'':'fill-ok';

  const catCards = Object.entries(byCat).map(([cat,amt])=>{
    const p = Math.min(100,Math.round(amt/total*100)||0);
    const ico = cat.split(' ')[0];
    return `<div class="cat-card">
      <div class="cat-top"><div class="cat-name">${ico} ${cat.substring(3)}</div><div class="cat-amt">${fmt(amt)}</div></div>
      <div class="cat-track"><div class="cat-fill" style="width:${p}%;opacity:.8"></div></div>
    </div>`;
  }).join('');

  const gList = [...gs].reverse().map(g=>`
    <div class="gasto-itm">
      <div class="gasto-cat">${g.cat.split(' ')[0]}</div>
      <div class="gasto-info">
        <div class="gasto-desc">${g.desc}</div>
        <div class="gasto-dt">${g.cat.substring(2)} ¬∑ ${fmtDate(g.date)}</div>
      </div>
      <div style="display:flex;align-items:center;gap:6px">
        <div class="gasto-amt">${fmt(g.amt)}</div>
        <button class="btn-del" onclick="delGasto(${g.id})">‚úï</button>
      </div>
    </div>`).join('');

  pg.innerHTML = `
    <div class="ptitle">Gastos <span class="hl">do Dia a Dia</span></div>
    <div class="cards">
      <div class="card full">
        <div class="clbl">Total Gasto em ${MS[cm]}</div>
        <div class="cval exp">${fmt(total)}</div>
        <div class="csub">${gs.length} lan√ßamentos</div>
      </div>
    </div>
    ${total>0?`
    <div class="pbar">
      <div class="pbar-bg">
        <div class="pbar-hdr">
          <div class="pbar-title" style="color:var(--d5)">Distribui√ß√£o por Categoria</div>
          <div class="pbar-pct">${fmt(total)} total</div>
        </div>
        <div class="cat-grid" style="padding:0;margin:8px 0 0">${catCards}</div>
      </div>
    </div>`:''}
    <div class="sec">
      <div class="sec-hdr"><div class="sec-lbl">üìã Hist√≥rico</div></div>
      ${gList||emptyH()}
    </div>
  `;
}

// ============ RENDER: CAIXINHA ============
function renderCaixinha() {
  const pg = document.getElementById('pg-caixinha');
  const bal = cxBalance();
  const monthTx = S.caixinha.filter(t=>t.month===cm&&t.year===cy);
  const mIn  = monthTx.filter(t=>t.type==='in').reduce((s,t)=>s+t.amt,0);
  const mOut = monthTx.filter(t=>t.type==='out').reduce((s,t)=>s+t.amt,0);
  const mNet = mIn - mOut; // positivo = guardou dinheiro, negativo = retirou

  // Agrupar por m√™s para hist√≥rico mensal
  const byMonth = {};
  S.caixinha.forEach(t => {
    const k = `${t.year}-${String(t.month+1).padStart(2,'0')}`;
    if(!byMonth[k]) byMonth[k]={label:MS[t.month]+'/'+t.year,in:0,out:0};
    if(t.type==='in') byMonth[k].in+=t.amt; else byMonth[k].out+=t.amt;
  });
  const monthSummary = Object.entries(byMonth).reverse().slice(0,6).map(([k,v])=>{
    const net=v.in-v.out;
    return `<div class="itm" style="opacity:.8">
      <div class="iico si">üìÖ</div>
      <div class="iinfo"><div class="iname">${v.label}</div><div class="itag">Guardou ${fmt(v.in)} ¬∑ Usou ${fmt(v.out)}</div></div>
      <div class="iamt ${net>=0?'pos':'neg'}">${net>=0?'+':''}${fmt(net,true)}</div>
    </div>`;
  }).join('');

  const hist = [...monthTx].reverse().map(t=>`
    <div class="itm">
      <div class="iico ${t.type==='in'?'si':'vfi'}">${t.type==='in'?'üí∞':'üí∏'}</div>
      <div class="iinfo">
        <div class="iname">${t.desc}</div>
        <div class="itag">${fmtDate(t.date)}</div>
      </div>
      <div class="iright">
        <div class="iamt ${t.type==='in'?'pos':'neg'}">${t.type==='in'?'+ guardou':'- usou'} ${fmt(t.amt)}</div>
        <button class="btn-del" onclick="delCx(${t.id})">‚úï</button>
      </div>
    </div>`).join('');

  pg.innerHTML = `
    <div class="ptitle">üí∞ <span class="hl">Caixinha</span></div>
    <div style="margin:14px 18px 0;background:var(--surface);border:2px solid rgba(107,255,184,.3);border-radius:14px;padding:18px;text-align:center">
      <div style="font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:6px">Saldo Guardado</div>
      <div style="font-family:var(--fh);font-size:38px;font-weight:800;color:${bal>=0?'var(--success)':'var(--danger)'}">${fmt(bal,true)}</div>
      <div style="font-size:11px;color:var(--muted);margin-top:6px">Este valor J√Å est√° descontado do seu saldo livre</div>
    </div>
    <div class="cx-btns" style="margin-top:12px">
      <button class="cx-btn cx-in" onclick="openCx('in')">üí∞ Guardar</button>
      <button class="cx-btn cx-out" onclick="openCx('out')">üí∏ Usar</button>
    </div>
    <div class="cards" style="padding-top:0">
      <div class="card ${mIn>0?'ok':''}">
        <div class="clbl">Guardado em ${MS[cm]}</div>
        <div class="cval pos">${fmt(mIn)}</div>
        <div class="csub">saiu do saldo dispon√≠vel</div>
      </div>
      <div class="card ${mOut>0?'bad':''}">
        <div class="clbl">Usado em ${MS[cm]}</div>
        <div class="cval ${mOut>0?'exp':'neu'}">${fmt(mOut)}</div>
        <div class="csub">voltou para o saldo</div>
      </div>
      <div class="card full ${mNet>=0?'ok':'bad'}">
        <div class="clbl">Movimento L√≠quido em ${MS[cm]}</div>
        <div class="cval ${mNet>=0?'pos':'neg'}">${mNet>=0?'+ guardou':'- retirou'} ${fmt(Math.abs(mNet))}</div>
      </div>
    </div>
    <div class="sec">
      <div class="sec-hdr"><div class="sec-lbl">üìã Movimenta√ß√µes de ${MS[cm]}</div></div>
      <div class="ilist">${hist||'<div class="empty">Nenhuma movimenta√ß√£o este m√™s</div>'}</div>
    </div>
    ${Object.keys(byMonth).length>0?`
    <div class="sec">
      <div class="sec-hdr"><div class="sec-lbl">üìÖ Hist√≥rico Mensal</div></div>
      <div class="ilist">${monthSummary}</div>
    </div>`:''}
  `;
}

// ============ RENDER: D√çVIDAS ============
function renderDividas() {
  const pg = document.getElementById('pg-dividas');
  const totalDivida = S.debts.reduce((s,d)=>s+d.total,0);
  const totalPago = S.debts.reduce((s,d)=>s+debtPaidTotal(d),0);
  const totalRest = S.debts.reduce((s,d)=>s+debtRemaining(d),0);
  const pct = totalDivida>0?Math.min(100,Math.round(totalPago/totalDivida*100)):0;

  const divCards = S.debts.map(d=>{
    const rest = debtRemaining(d);
    const paid = debtPaidTotal(d);
    const p = d.total>0?Math.min(100,Math.round(paid/d.total*100)):0;
    const parcPagas = d.kind==='parcelada' ? Math.round(paid / (d.monthly||1)) : null;
    const parcRest  = d.kind==='parcelada' ? Math.max(0, d.nParcelas - parcPagas) : null;
    const months = d.monthly>0?Math.ceil(rest/d.monthly):null;
    const done = rest<=0;
    const dayLabel = d.day ? `Dia ${String(d.day).padStart(2,'0')}` : '';
    return `
    <div class="div-card" style="${done?'opacity:.5':''}">
      <div class="div-hdr">
        <div>
          <div class="div-name">${d.name} ${done?'‚úì':''}</div>
          <div class="div-who">${d.who}${dayLabel?' ¬∑ '+dayLabel:''}</div>
          ${d.note?`<div class="div-who" style="color:var(--d5)">${d.note}</div>`:''}
          ${d.kind==='parcelada'&&!done?`<div class="payoff-badge">${parcRest}x de ${fmt(d.monthly)} restantes</div>`:''}
        </div>
        <div class="div-right">
          <div class="div-rest">${fmt(rest)}</div>
          <div class="div-total">de ${fmt(d.total)}</div>
          ${months&&!done&&d.kind!=='parcelada'?`<div class="div-months">~${months} meses</div>`:''}
        </div>
      </div>
      <div class="pbar-bg" style="padding:10px">
        <div class="pbar-hdr" style="margin-bottom:6px">
          <div style="font-size:10px;color:var(--muted)">Pago ${fmt(paid)}</div>
          <div style="font-size:10px;color:var(--muted)">${p}%</div>
        </div>
        <div class="track"><div class="fill ${p>70?'fill-ok':'fill-bad'}" style="width:${p}%"></div></div>
      </div>
      <div class="div-actions">
        ${!done?`<button class="div-pay-btn" onclick="openDivPay(${d.id},'${d.name}',${d.monthly||0})">+ Registrar Pagamento</button>`:'<button class="div-pay-btn" style="opacity:.5" disabled>Quitada ‚úì</button>'}
        <button class="div-del-btn" onclick="delDiv(${d.id})">‚úï</button>
      </div>
    </div>`;
  }).join('');

  pg.innerHTML = `
    <div class="ptitle">üìã <span class="hl">D√≠vidas</span></div>
    ${S.debts.length?`
    <div class="cards">
      <div class="card bad full">
        <div class="clbl">Total em Aberto</div>
        <div class="cval exp">${fmt(totalRest)}</div>
        <div class="csub">${S.debts.filter(d=>debtRemaining(d)>0).length} d√≠vida(s) ativa(s) ¬∑ ${fmt(totalPago)} j√° pago</div>
      </div>
    </div>
    <div class="pbar">
      <div class="pbar-bg">
        <div class="pbar-hdr">
          <div class="pbar-title" style="color:var(--success)">Progresso Geral de Quita√ß√£o</div>
          <div class="pbar-pct">${pct}%</div>
        </div>
        <div class="track"><div class="fill fill-ok" style="width:${pct}%"></div></div>
        <div class="pbar-detail"><span>Pago: ${fmt(totalPago)}</span><span>Total: ${fmt(totalDivida)}</span></div>
      </div>
    </div>`:`<div class="nodebts"><div class="big">üéâ</div><p>Nenhuma d√≠vida cadastrada.<br>Quando tiver, registre aqui<br>para acompanhar a quita√ß√£o.</p></div>`}
    ${divCards}
  `;
}

// ============ RENDER: DASH ============
function renderDash() {
  const pg = document.getElementById('pg-dash');
  const e5  = periodEntries(5);
  const e20 = periodEntries(20);

  const in5   = sumT(e5,['income']),  out5  = sumT(e5,['fixed','variable','variable_fixed']);
  const in20  = sumT(e20,['income']), out20 = sumT(e20,['fixed','variable','variable_fixed']);
  const transf = getTransf() ?? 0;
  const bal5  = in5 - out5 - transf;   // dia 05 desconta a transfer√™ncia
  const bal20 = (in20 + transf) - out20; // dia 20 recebe a transfer√™ncia
  const balTotal = bal20; // saldo real do m√™s

  const paid5out  = sumPaid(e5,['fixed','variable','variable_fixed']);
  const paid20out = sumPaid(e20,['fixed','variable','variable_fixed']);
  const totalPlanned = out5+out20;
  const totalPaid = paid5out+paid20out;
  const paidPct = totalPlanned>0?Math.min(100,Math.round(totalPaid/totalPlanned*100)):0;

  const gasTotal = monthGastos().reduce((s,g)=>s+g.amt,0);
  const cxBal = cxBalance();
  const divRest = S.debts.reduce((s,d)=>s+debtRemaining(d),0);

  const pendente5 = e5.filter(e=>e.type!=='income'&&!isPaid(e.id));
  const pendente20= e20.filter(e=>e.type!=='income'&&!isPaid(e.id));

  const insights = [];
  if(bal5<0) insights.push({t:'red',m:`‚ö†Ô∏è Dia 05 no vermelho: sa√≠das superam entradas em ${fmt(Math.abs(bal5))}`});
  if(bal20<0) insights.push({t:'red',m:`‚ö†Ô∏è Dia 20 no vermelho ‚Äî falta ${fmt(Math.abs(bal20))} mesmo com a transfer√™ncia do Dia 05`});
  if(balTotal>0&&gasTotal>balTotal*.5) insights.push({t:'warn',m:`üí∏ Gastos do dia a dia (${fmt(gasTotal)}) est√£o consumindo mais de 50% do saldo previsto`});
  if(cxBal>0) insights.push({t:'good',m:`üí∞ Caixinha com ${fmt(cxBal)} dispon√≠vel`});
  if(divRest>0) insights.push({t:'warn',m:`üìã ${fmt(divRest)} ainda em d√≠vidas ‚Äî lembre de alocar parte do saldo`});
  if(paidPct===100) insights.push({t:'good',m:`‚úì Todas as contas deste m√™s est√£o pagas! üéâ`});
  else if(pendente5.length+pendente20.length>0) insights.push({t:'warn',m:`‚è≥ ${pendente5.length+pendente20.length} conta(s) ainda pendentes este m√™s`});

  pg.innerHTML = `
    <div class="ptitle" style="display:flex;align-items:center;justify-content:space-between;padding-right:18px">
      <div>üìä <span class="hl">Dashboard</span></div>
      <button onclick="syncSheets()" id="syncBtn" style="background:var(--surface);border:1.5px solid var(--border);border-radius:10px;padding:8px 14px;color:var(--text);font-family:var(--fh);font-weight:700;font-size:12px;cursor:pointer;display:flex;align-items:center;gap:6px">
        <span id="syncIco">üì§</span> <span id="syncTxt">Sincronizar</span>
      </button>
    </div>
    <div class="pbar" style="margin-top:14px">
      <div class="pbar-bg">
        <div class="pbar-hdr">
          <div class="pbar-title">Contas Pagas este M√™s</div>
          <div class="pbar-pct">${paidPct}%</div>
        </div>
        <div class="track"><div class="fill fill-ok" style="width:${paidPct}%"></div></div>
        <div class="pbar-detail"><span>Pago: ${fmt(totalPaid)}</span><span>Planejado: ${fmt(totalPlanned)}</span></div>
      </div>
    </div>
    <div class="cards">
      <div class="card ${bal5>=0?'ok':'bad'}">
        <div class="clbl" style="color:var(--d5)">Saldo Dia 05</div>
        <div class="cval ${bal5>=0?'pos':'neg'}">${fmt(bal5,true)}</div>
        <div class="csub">${fmt(in5)} sal ‚àí ${fmt(out5)} contas${transf>0?' ‚àí '+fmt(transf)+' guardado':''}</div>
      </div>
      <div class="card ${bal20>=0?'ok':'bad'}">
        <div class="clbl" style="color:var(--d20)">Saldo Final Dia 20</div>
        <div class="cval ${bal20>=0?'pos':'neg'}">${fmt(bal20,true)}</div>
        <div class="csub">${fmt(in20)} sal${transf>0?' + '+fmt(transf)+' do D05':''} ‚àí ${fmt(out20)} contas</div>
      </div>
      <div class="card ${balTotal>=0?'ok':'bad'} full">
        <div class="clbl">Saldo Real do M√™s</div>
        <div class="cval ${balTotal>=0?'pos':'neg'}">${fmt(balTotal,true)}</div>
      </div>
      <div class="card">
        <div class="clbl">üí∏ Gastos D.a.D.</div>
        <div class="cval exp">${fmt(gasTotal)}</div>
        <div class="csub">${monthGastos().length} lan√ßamentos</div>
      </div>
      <div class="card sav">
        <div class="clbl">üí∞ Caixinha</div>
        <div class="cval ${cxBal>=0?'pos':'neg'}">${fmt(cxBal,true)}</div>
        <div class="csub">saldo acumulado</div>
      </div>
      ${S.debts.length?`
      <div class="card bad full">
        <div class="clbl">üìã D√≠vidas Restantes</div>
        <div class="cval exp">${fmt(divRest)}</div>
        <div class="csub">${S.debts.filter(d=>debtRemaining(d)>0).length} d√≠vida(s) ativa(s)</div>
      </div>`:''}
    </div>
    ${insights.map(i=>`<div class="insight ${i.t}">${i.m}</div>`).join('')}
    <div class="sec">
      <div class="sec-hdr"><div class="sec-lbl">‚è≥ Contas Pendentes</div></div>
      <div class="ilist">
        ${[...pendente5,...pendente20].map(e=>`
          <div class="itm">
            <div class="iico fi">üîí</div>
            <div class="iinfo">
              <div class="iname">${e.name}</div>
              <div class="itag">Dia ${String(e.day).padStart(2,'0')}</div>
            </div>
            <div class="iright">
              <div class="iamt neg">${fmt(getAmt(e)||0)}</div>
              <button class="btn-pay" onclick="openPay(${e.id},'${e.name}',${getAmt(e)||0})"></button>
            </div>
          </div>`).join('')||emptyH()}
      </div>
    </div>
  `;
}

// ============ MODAL: Reserva ============
function openReserva() {
  const cur = getReserva();
  // inline quick modal
  const existing = document.getElementById('modalReservaInline');
  if(existing) existing.remove();

  const div = document.createElement('div');
  div.id = 'modalReservaInline';
  div.className = 'mbg open';
  div.innerHTML = `
    <div class="modal">
      <div class="mhandle"></div>
      <div class="mtitle">üéØ Reserva para o Dia 20</div>
      <div class="ibox">Meta mensal: ${fmt(RESERVA_META)}. Coloque quanto voc√™ conseguiu guardar ‚Äî pode ser menos, tudo bem!</div>
      <div class="field"><label>Quanto guardou (R$)</label><input type="number" id="rVal" placeholder="0,00" step="0.01" min="0" value="${cur!==null?cur:''}"></div>
      <div style="display:flex;gap:8px;margin-top:5px">
        <button class="btn-sv" onclick="saveReserva()">Salvar</button>
        <button class="btn-cv" style="margin-top:0" onclick="document.getElementById('modalReservaInline').remove()">Cancelar</button>
      </div>
    </div>`;
  div.addEventListener('click', e=>{ if(e.target===div) div.remove(); });
  document.body.appendChild(div);
  setTimeout(()=>document.getElementById('rVal').focus(),300);
}

function saveReserva() {
  const v = parseFloat(document.getElementById('rVal').value);
  if(isNaN(v)||v<0) return;
  setReserva(v); persist();
  document.getElementById('modalReservaInline').remove();
  render();
}

function clearReserva() {
  if(!confirm('Limpar o valor da reserva deste m√™s?')) return;
  setReserva(null); persist(); render();
}

// ============ MODALS: Entry ============
function openEntry(type, day) {
  document.getElementById('eName').value='';
  document.getElementById('eAmt').value='';
  document.getElementById('eType').value=type||'fixed';
  document.getElementById('eDay').value=day||subDay;
  onEType();
  openM('mEntry');
  setTimeout(()=>document.getElementById('eName').focus(),350);
}

function onEType() {
  const t=document.getElementById('eType').value;
  const ib=document.getElementById('mEntryInfo');
  const af=document.getElementById('eAmtF');
  const rf=document.getElementById('eRecF');
  if(t==='variable_fixed'){
    ib.style.display='block';
    ib.textContent='‚ö° Aparece todo m√™s ‚Äî voc√™ define o valor manualmente cada m√™s (ex: Luz, √Ågua, Cart√£o).';
    af.style.display='none'; rf.style.display='none';
  } else {
    ib.style.display='none'; af.style.display='block'; rf.style.display='block';
    document.getElementById('eRec').value=t==='variable'?'once':'monthly';
  }
}

function saveEntry() {
  const name=document.getElementById('eName').value.trim();
  const type=document.getElementById('eType').value;
  const day=parseInt(document.getElementById('eDay').value);
  const rec=document.getElementById('eRecF').style.display==='none'?'monthly':document.getElementById('eRec').value;
  if(!name){document.getElementById('eName').style.borderColor='var(--danger)';return;}
  document.getElementById('eName').style.borderColor='';
  let amount=0;
  if(type!=='variable_fixed'){
    amount=parseFloat(document.getElementById('eAmt').value);
    if(isNaN(amount)||amount<0){document.getElementById('eAmt').style.borderColor='var(--danger)';return;}
    document.getElementById('eAmt').style.borderColor='';
  }
  const e={id:S.nextId++,name,amount,type,day,rec};
  if(rec==='once'){e.month=cm;e.year=cy;}
  S.entries.push(e); persist(); closeM('mEntry'); render();
}

function delEntry(id) {
  if(!confirm('Remover este item?'))return;
  S.entries=S.entries.filter(e=>e.id!==id);
  delete S.payments[pkey(id)]; persist(); render();
}

// ============ MODALS: Variable Amount ============
function openVAmt(id, name) {
  valId=id;
  document.getElementById('mValTitle').textContent=name+' ‚Äî '+MF[cm];
  const cur=S.mv[mkey(id)];
  document.getElementById('vAmt').value=cur!==undefined?cur:'';
  openM('mVal');
  setTimeout(()=>document.getElementById('vAmt').focus(),350);
}

function saveVAmt() {
  const v=parseFloat(document.getElementById('vAmt').value);
  if(isNaN(v)||v<0)return;
  S.mv[mkey(valId)]=v; persist(); closeM('mVal'); render();
}

// ============ MODALS: Pay ============
function openPay(id, name, planned) {
  payingId=id;
  const alreadyPaid=isPaid(id);
  document.getElementById('mPayTitle').textContent=(alreadyPaid?'Editar: ':'Marcar como Pago: ')+name;
  document.getElementById('mPayInfo').textContent=`Valor planejado: ${fmt(planned)}`;
  document.getElementById('pAmt').value=alreadyPaid?paidAmt(id):planned;
  document.getElementById('mPay').querySelector('.btn-cv[style]').style.display=alreadyPaid?'block':'none';
  openM('mPay');
  setTimeout(()=>document.getElementById('pAmt').select(),350);
}

function confirmPay() {
  const v=parseFloat(document.getElementById('pAmt').value);
  if(isNaN(v)||v<0)return;
  S.payments[pkey(payingId)]={paid:true,amount:v};
  persist(); closeM('mPay'); render();
}

function unpay() {
  delete S.payments[pkey(payingId)];
  persist(); closeM('mPay'); render();
}

// ============ MODALS: Gasto ============
function openGasto() {
  document.getElementById('gDesc').value='';
  document.getElementById('gAmt').value='';
  openM('mGasto');
  setTimeout(()=>document.getElementById('gDesc').focus(),350);
}

function saveGasto() {
  const desc=document.getElementById('gDesc').value.trim();
  const amt=parseFloat(document.getElementById('gAmt').value);
  const cat=document.getElementById('gCat').value;
  if(!desc||isNaN(amt)||amt<=0)return;
  S.gastos.push({id:S.nextGId++,desc,amt,cat,date:new Date().toISOString(),month:cm,year:cy});
  persist(); closeM('mGasto'); render();
}

function delGasto(id) {
  if(!confirm('Remover?'))return;
  S.gastos=S.gastos.filter(g=>g.id!==id); persist(); render();
}

// ============ MODALS: D√≠vida ============
function openDiv() {
  const sv = (id,v='')=>{ const el=document.getElementById(id); if(el) el.value=v; };
  sv('dName'); sv('dWho'); sv('dNote');
  sv('dTotal'); sv('dNParcelas'); sv('dMonthly');
  sv('dTotalAberta'); sv('dPaid','0'); sv('dMonthlyAberta');
  sv('dPagas','0'); sv('dKind','parcelada');
  const info=document.getElementById('dParcelaInfo'); if(info) info.style.display='none';
  onDKind();
  openM('mDiv');
  setTimeout(()=>document.getElementById('dName').focus(),350);
}

function onDKind() {
  const k = document.getElementById('dKind').value;
  document.getElementById('dParcelaFields').style.display = k==='parcelada'?'':'none';
  document.getElementById('dAbertaFields').style.display  = k==='aberta'?'':'none';
}

function calcParcela() {
  const total = parseFloat(document.getElementById('dTotal').value)||0;
  const n     = parseInt(document.getElementById('dNParcelas').value)||0;
  if(total>0 && n>0) {
    const parcela = total/n;
    document.getElementById('dMonthly').value = parcela.toFixed(2);
    showParcelaInfo(total, n, parcela);
  }
}

function calcParcelaRev() {
  const monthly = parseFloat(document.getElementById('dMonthly').value)||0;
  const n       = parseInt(document.getElementById('dNParcelas').value)||0;
  if(monthly>0 && n>0) {
    const total = monthly*n;
    document.getElementById('dTotal').value = total.toFixed(2);
    showParcelaInfo(total, n, monthly);
  }
}

function showParcelaInfo(total, n, parcela) {
  const pagas = parseInt(document.getElementById('dPagas').value)||0;
  const rest  = Math.max(0, n-pagas);
  const info  = document.getElementById('dParcelaInfo');
  info.style.display = 'block';
  info.innerHTML = `${pagas>0?pagas+' paga(s) ¬∑ ':''}<strong>${rest} restante(s)</strong> de ${fmt(parcela)} = <strong>${fmt(parcela*rest)} ainda a pagar</strong>`;
}

function saveDiv() {
  const name = document.getElementById('dName').value.trim();
  const who  = document.getElementById('dWho').value.trim();
  const kind = document.getElementById('dKind').value;
  const note = document.getElementById('dNote').value.trim();
  const day  = parseInt(document.getElementById('dDay').value);

  if(!name) return;

  let debt = {id:S.nextDId++, name, who, note, day, kind};

  if(kind==='parcelada') {
    const total    = parseFloat(document.getElementById('dTotal').value)||0;
    const nParc    = parseInt(document.getElementById('dNParcelas').value)||0;
    const monthly  = parseFloat(document.getElementById('dMonthly').value)||0;
    const pagas    = parseInt(document.getElementById('dPagas').value)||0;
    if(total<=0||nParc<=0) return;
    debt.total      = total;
    debt.nParcelas  = nParc;
    debt.monthly    = monthly || total/nParc;
    debt.initialPaid= pagas * debt.monthly;
    debt.parcPagas  = pagas;
  } else {
    const total   = parseFloat(document.getElementById('dTotalAberta').value)||0;
    const paid    = parseFloat(document.getElementById('dPaid').value)||0;
    const monthly = parseFloat(document.getElementById('dMonthlyAberta').value)||0;
    if(total<=0) return;
    debt.total       = total;
    debt.monthly     = monthly;
    debt.initialPaid = paid;
  }

  S.debts.push(debt);
  persist(); closeM('mDiv'); render();
}

function openDivPay(id, name, suggested) {
  divPayId=id;
  document.getElementById('mDivPayTitle').textContent='Pagar: '+name;
  document.getElementById('dpAmt').value=suggested||'';
  document.getElementById('dpNote').value='';
  openM('mDivPay');
  setTimeout(()=>document.getElementById('dpAmt').focus(),350);
}

function saveDivPay() {
  const amt=parseFloat(document.getElementById('dpAmt').value);
  const note=document.getElementById('dpNote').value.trim();
  if(isNaN(amt)||amt<=0)return;
  S.debtPays.push({id:S.nextDPId++,dId:divPayId,amt,note,date:new Date().toISOString(),month:cm,year:cy});
  persist(); closeM('mDivPay'); render();
}

function delDiv(id) {
  if(!confirm('Remover esta d√≠vida e todos os pagamentos?'))return;
  S.debts=S.debts.filter(d=>d.id!==id);
  S.debtPays=S.debtPays.filter(p=>p.dId!==id);
  persist(); render();
}

// ============ MODALS: Caixinha ============
function openCx(type) {
  cxType=type;
  document.getElementById('mCxTitle').textContent=type==='in'?'üí∞ Guardar na Caixinha':'üí∏ Usar da Caixinha';
  document.getElementById('cxSvBtn').textContent=type==='in'?'‚úì Guardar':'‚úì Confirmar Uso';
  document.getElementById('cxDesc').value='';
  document.getElementById('cxAmt').value='';
  openM('mCx');
  setTimeout(()=>document.getElementById('cxDesc').focus(),350);
}

function saveCx() {
  const desc=document.getElementById('cxDesc').value.trim();
  const amt=parseFloat(document.getElementById('cxAmt').value);
  if(!desc||isNaN(amt)||amt<=0)return;
  S.caixinha.push({id:S.nextCxId++,type:cxType,desc,amt,date:new Date().toISOString(),month:cm,year:cy});
  persist(); closeM('mCx'); render();
}

function delCx(id) {
  if(!confirm('Remover?'))return;
  S.caixinha=S.caixinha.filter(t=>t.id!==id); persist(); render();
}

// ============ MODAL UTILS ============
function openM(id) { document.getElementById(id).classList.add('open'); }
function closeM(id) { document.getElementById(id).classList.remove('open'); }
function closeBg(id) { }  // handled per modal to avoid accidental close

document.querySelectorAll('.mbg').forEach(bg=>{
  bg.addEventListener('click',e=>{ if(e.target===bg) bg.classList.remove('open'); });
});

// ============ NAVIGATION ============
function setPage(p) {
  curPage=p;
  document.querySelectorAll('.page').forEach(el=>el.classList.remove('active'));
  document.getElementById('pg-'+p).classList.add('active');
  document.querySelectorAll('.bnt').forEach(b=>b.classList.remove('active'));
  document.getElementById('bnav-'+p).classList.add('active');
  // FAB action per page
  const fabLabels={plano:'Ôºã',gastos:'Ôºã',caixinha:'Ôºã',dividas:'Ôºã D√≠vida',dash:'‚Äî'};
  document.getElementById('fabBtn').textContent=fabLabels[p]||'Ôºã';
  document.getElementById('fabBtn').style.display=p==='dash'?'none':'flex';
  render();
}

function fabAction() {
  if(curPage==='plano')openEntry(null,subDay);
  else if(curPage==='gastos')openGasto();
  else if(curPage==='caixinha')openCx('in');
  else if(curPage==='dividas')openDiv();
}

function setSubDay(d) { subDay=d; render(); }

function chM(dir) {
  cm+=dir;
  if(cm>11){cm=0;cy++;} if(cm<0){cm=11;cy--;}
  render();
}

// ============ RENDER ROUTER ============
function render() {
  document.getElementById('mlbl').textContent=MS[cm]+' '+cy;
  if(curPage==='plano')renderPlano();
  else if(curPage==='gastos')renderGastos();
  else if(curPage==='caixinha')renderCaixinha();
  else if(curPage==='dividas')renderDividas();
  else if(curPage==='dash')renderDash();
}


// ============ SETTINGS ============
function openSettings() {
  const url  = localStorage.getItem('scriptUrl') || '';
  const name = localStorage.getItem('sheetName') || '';
  document.getElementById('scriptUrl').value = url;
  document.getElementById('sheetName').value = name;
  openM('mSettings');
}

function saveSettings() {
  const url  = document.getElementById('scriptUrl').value.trim();
  const name = document.getElementById('sheetName').value.trim();
  localStorage.setItem('scriptUrl', url);
  localStorage.setItem('sheetName', name);
  closeM('mSettings');
}

// ============ SYNC ============
function buildPayload() {
  const MF = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
  const e5  = periodEntries(5);
  const e20 = periodEntries(20);
  const transf = getTransf() ?? 0;

  const in5   = sumT(e5,['income']);
  const out5  = sumT(e5,['fixed','variable','variable_fixed']);
  const in20  = sumT(e20,['income']);
  const out20 = sumT(e20,['fixed','variable','variable_fixed']);
  const bal5  = in5 - out5 - transf;
  const bal20 = (in20 + transf) - out20;

  const gastos  = monthGastos().reduce((s,g)=>s+g.amt,0);
  const caixinha= cxBalance();
  const dividas = S.debts.reduce((s,d)=>s+debtRemaining(d),0);

  function mapEntry(e) {
    return {
      name: e.name, type: e.type, rec: e.rec,
      planned: getAmt(e) || 0,
      paid: isPaid(e.id),
      paidAmt: isPaid(e.id) ? paidAmt(e.id) : 0
    };
  }

  return {
    mes: MF[cm] + ' ' + cy,
    resumo: { in5, out5, transf, bal5, in20, out20, bal20, gastos, caixinha, dividas },
    dia05: e5.filter(e=>e.type!=='income').map(mapEntry),
    dia20: e20.filter(e=>e.type!=='income').map(mapEntry),
    gastos: monthGastos().map(g=>({ date: fmtDate(g.date), cat: g.cat, desc: g.desc, amt: g.amt })),
    dividas: S.debts.map(d=>({
      name: d.name, who: d.who, kind: d.kind||'aberta', note: d.note||'',
      day: d.day||0, total: d.total, paid: debtPaidTotal(d),
      remaining: debtRemaining(d), monthly: d.monthly||0, nParcelas: d.nParcelas||0
    })),
    caixinha: S.caixinha.filter(t=>t.month===cm&&t.year===cy)
      .map(t=>({ date: fmtDate(t.date), type: t.type, desc: t.desc, amt: t.amt }))
  };
}

async function syncSheets() {
  const url = localStorage.getItem('scriptUrl');
  if (!url) {
    openSettings();
    return;
  }

  const btn  = document.getElementById('syncBtn');
  const ico  = document.getElementById('syncIco');
  const txt  = document.getElementById('syncTxt');
  btn.disabled = true;
  ico.textContent = '‚è≥';
  txt.textContent = 'Enviando...';

  try {
    const payload = buildPayload();
    const res = await fetch(url, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    // no-cors n√£o retorna body, mas se chegou aqui funcionou
    ico.textContent = '‚úÖ';
    txt.textContent = 'Sincronizado!';
    document.getElementById('syncResultTitle').textContent = '‚úÖ Dados enviados!';
    document.getElementById('syncResultMsg').innerHTML =
      `Dados de <strong>${['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'][cm]} ${cy}</strong> foram enviados para sua planilha.<br><br>
       Abas atualizadas:<br>
       üìä Resumo ¬∑ üìÖ Dia 05 ¬∑ üìÖ Dia 20<br>üí∏ Gastos ¬∑ üìã D√≠vidas ¬∑ üí∞ Caixinha`;
    openM('mSyncResult');

  } catch(err) {
    ico.textContent = '‚ùå';
    txt.textContent = 'Erro';
    document.getElementById('syncResultTitle').textContent = '‚ùå Erro ao sincronizar';
    document.getElementById('syncResultMsg').textContent = 'Verifique a URL do Apps Script nas configura√ß√µes. Erro: ' + err.message;
    openM('mSyncResult');
  } finally {
    setTimeout(()=>{ btn.disabled=false; ico.textContent='üì§'; txt.textContent='Sincronizar'; }, 4000);
  }
}

// ============ PWA ============
if('serviceWorker'in navigator){
  const sw=`const C='fc-v4';self.addEventListener('install',e=>e.waitUntil(caches.open(C)));self.addEventListener('fetch',e=>e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request))));`;
  navigator.serviceWorker.register(URL.createObjectURL(new Blob([sw],{type:'application/javascript'}))).catch(()=>{});
}

// ============ INIT ============
setPage('plano');
</script>
</body>
</html>
