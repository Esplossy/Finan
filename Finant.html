<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<meta name="theme-color" content="#090910">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Finanças">
<title>Meu Caixa</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#090910;--sf:#111120;--sf2:#181828;--bd:#252540;
  --d5:#f7c948;--d20:#4fd1c5;--ok:#6bffb8;--err:#ff6b6b;--sav:#c084fc;
  --mu:#606080;--tx:#eeeef8;--tx2:#9090b8;
  --r:13px;--fh:'Syne',sans-serif;--fm:'DM Mono',monospace;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{background:var(--bg);color:var(--tx);font-family:var(--fm);min-height:100dvh;padding-bottom:72px}
.hdr{position:sticky;top:0;z-index:50;background:rgba(9,9,16,.96);backdrop-filter:blur(20px);
  border-bottom:1px solid var(--bd);padding:10px 16px;display:flex;align-items:center;justify-content:space-between}
.hdr-logo{font-family:var(--fh);font-weight:800;font-size:17px}
.hdr-logo span{color:var(--d5)}
.hdr-right{display:flex;align-items:center;gap:8px}
.btn-ico{background:var(--sf);border:1px solid var(--bd);border-radius:8px;color:var(--tx2);
  padding:5px 10px;font-size:13px;cursor:pointer;transition:all .15s}
.btn-ico:hover{border-color:var(--d5);color:var(--d5)}
.mnav{display:flex;align-items:center;gap:6px}
.btn-mn{background:var(--sf);border:1px solid var(--bd);border-radius:8px;color:var(--tx2);
  padding:4px 11px;font-family:var(--fm);font-size:12px;cursor:pointer;transition:all .15s}
.btn-mn:hover{border-color:var(--d5);color:var(--d5)}
.mlbl{font-family:var(--fh);font-weight:700;font-size:13px;min-width:88px;text-align:center;
  cursor:pointer;color:var(--tx2);transition:color .2s}
.mlbl.now{color:var(--d5)}
.bnav{position:fixed;bottom:0;left:0;right:0;z-index:50;background:rgba(9,9,16,.97);
  backdrop-filter:blur(20px);border-top:1px solid var(--bd);display:flex}
.bnt{flex:1;padding:7px 2px 9px;border:none;background:transparent;color:var(--mu);
  cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:2px;
  font-family:var(--fm);font-size:9px;letter-spacing:.4px;transition:color .15s}
.bnt .ico{font-size:19px;line-height:1}
.bnt.on{color:var(--d5)}
.cards{display:grid;grid-template-columns:1fr 1fr;gap:9px;padding:13px 16px}
.card{background:var(--sf);border:1px solid var(--bd);border-radius:var(--r);padding:12px}
.card.full{grid-column:1/-1}
.card.cok{border-color:rgba(107,255,184,.3);background:rgba(107,255,184,.04)}
.card.cerr{border-color:rgba(255,107,107,.3);background:rgba(255,107,107,.04)}
.card.csav{border-color:rgba(192,132,252,.3);background:rgba(192,132,252,.04)}
.card.cd5{border-color:rgba(247,201,72,.3);background:rgba(247,201,72,.03)}
.clbl{font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--mu);margin-bottom:3px}
.cval{font-family:var(--fh);font-size:18px;font-weight:700}
.cval.vok{color:var(--ok)}.cval.verr{color:var(--err)}.cval.vsav{color:var(--sav)}.cval.vd5{color:var(--d5)}.cval.vd20{color:var(--d20)}
.csub{font-size:10px;color:var(--mu);margin-top:3px;line-height:1.4}
.tabs{display:flex;gap:7px;padding:13px 16px 0}
.tab{flex:1;padding:8px;border-radius:11px;border:2px solid var(--bd);background:transparent;
  color:var(--mu);font-family:var(--fh);font-weight:700;font-size:13px;cursor:pointer;transition:all .2s}
.tab.on5{border-color:var(--d5);color:var(--d5);background:rgba(247,201,72,.07)}
.tab.on20{border-color:var(--d20);color:var(--d20);background:rgba(79,209,197,.07)}
.alert{margin:10px 16px 0;padding:9px 12px;border-radius:10px;font-size:11px;line-height:1.5;display:flex;align-items:center;gap:7px}
.alert.aok{background:rgba(107,255,184,.08);border:1px solid rgba(107,255,184,.2);color:var(--ok)}
.alert.awk{background:rgba(247,201,72,.07);border:1px solid rgba(247,201,72,.2);color:var(--d5)}
.alert.aer{background:rgba(255,107,107,.09);border:1px solid rgba(255,107,107,.25);color:var(--err)}
.sec{padding:0 16px;margin-bottom:4px}
.sec-hdr{display:flex;align-items:center;justify-content:space-between;margin:15px 0 8px}
.sec-lbl{font-family:var(--fh);font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--mu)}
.sec-acts{display:flex;gap:6px;align-items:center}
.btn-sm{padding:4px 10px;border-radius:7px;border:1.5px solid var(--bd);background:transparent;
  color:var(--tx2);font-family:var(--fh);font-weight:700;font-size:10px;cursor:pointer;transition:all .15s}
.btn-sm:hover{border-color:var(--d5);color:var(--d5)}
.btn-add{width:27px;height:27px;border-radius:7px;border:1.5px solid var(--bd);background:var(--sf);
  color:var(--tx2);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s}
.btn-add:hover{border-color:var(--d5);color:var(--d5)}
.transf-box{margin:10px 16px 0;background:var(--sf);border:2px solid var(--bd);border-radius:13px;padding:13px}
.transf-box.tset{border-color:rgba(192,132,252,.4)}
.trow{display:flex;align-items:center;justify-content:space-between}
.tlbl{font-family:var(--fh);font-weight:700;font-size:13px;color:var(--sav)}
.tsub{font-size:10px;color:var(--mu);margin-top:2px}
.tval{font-family:var(--fh);font-weight:800;font-size:19px}
.tbtns{display:flex;gap:6px;margin-top:10px}
.tbtn{flex:1;padding:8px;border-radius:9px;border:1.5px solid rgba(192,132,252,.3);
  background:rgba(192,132,252,.12);color:var(--sav);font-family:var(--fh);font-weight:700;font-size:12px;cursor:pointer;transition:opacity .15s}
.tbtn:hover{opacity:.8}
.tbtn.tc{background:rgba(255,107,107,.08);color:var(--err);border-color:rgba(255,107,107,.2)}
.ilist{display:flex;flex-direction:column;gap:6px}
.itm{background:var(--sf);border:1px solid var(--bd);border-radius:11px;padding:11px 12px;
  display:flex;align-items:center;gap:9px;transition:all .2s}
.itm.pd{opacity:.55;border-style:dashed;border-left:3px solid var(--ok)}
.itm.pd .iname{text-decoration:line-through}
.iico{width:30px;height:30px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0}
.iico.tincome{background:rgba(107,255,184,.1)}.iico.tfixed{background:rgba(79,209,197,.1)}
.iico.tvariable{background:rgba(247,201,72,.1)}.iico.tvf{background:rgba(255,107,107,.08)}.iico.tdebt{background:rgba(192,132,252,.12)}
.iinfo{flex:1;min-width:0}
.iname{font-family:var(--fh);font-weight:600;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.imeta{font-size:9px;color:var(--mu);margin-top:2px;display:flex;align-items:center;gap:5px;flex-wrap:wrap}
.tag{display:inline-block;padding:1px 6px;border-radius:20px;font-size:8px;font-weight:600}
.tag.tfixed{background:rgba(79,209,197,.12);color:var(--d20)}.tag.tvariable{background:rgba(247,201,72,.1);color:var(--d5)}
.tag.tvf{background:rgba(255,107,107,.1);color:var(--err)}.tag.tdebt{background:rgba(192,132,252,.12);color:var(--sav)}
.iright{display:flex;align-items:center;gap:5px;flex-shrink:0}
.iamt{font-weight:500;font-size:13px}
.iamt.vok{color:var(--ok)}.iamt.verr{color:var(--err)}.iamt.vmu{color:var(--mu);font-size:11px;font-style:italic}
.btn-pay{width:30px;height:30px;border-radius:50%;border:2px solid var(--bd);background:transparent;
  cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;
  transition:all .2s;font-size:12px;color:transparent}
.btn-pay:hover{border-color:var(--ok);color:var(--ok)}
.btn-pay.done{border-color:var(--ok);background:rgba(107,255,184,.15);color:var(--ok)}
.btn-edit{width:26px;height:26px;border-radius:7px;border:none;background:rgba(79,209,197,.1);
  color:var(--d20);font-size:11px;cursor:pointer;opacity:.7;transition:opacity .15s}
.btn-edit:hover{opacity:1}
.btn-del{width:26px;height:26px;border-radius:7px;border:none;background:rgba(255,107,107,.08);
  color:var(--err);font-size:11px;cursor:pointer;opacity:.35;transition:opacity .15s}
.btn-del:hover{opacity:1}
.empty{text-align:center;padding:16px;color:var(--mu);font-size:11px;border:1.5px dashed var(--bd);border-radius:11px}
.pbar-wrap{margin:0 16px 4px;background:var(--sf);border:1px solid var(--bd);border-radius:var(--r);padding:12px}
.pbar-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:7px}
.pbar-ttl{font-family:var(--fh);font-weight:700;font-size:12px}
.pbar-pct{font-size:11px;color:var(--mu)}
.track{height:6px;background:var(--bd);border-radius:99px;overflow:hidden}
.fill{height:100%;border-radius:99px;transition:width .5s ease}
.f-ok{background:linear-gradient(90deg,var(--ok),#22d3ee)}
.f-err{background:linear-gradient(90deg,var(--err),#f97316)}
.pbar-sub{display:flex;justify-content:space-between;margin-top:6px;font-size:10px;color:var(--mu)}
.dcard{background:var(--sf);border:1px solid var(--bd);border-radius:12px;padding:13px;margin:0 16px 9px}
.dcard.ddone{opacity:.5}
.dcard-hdr{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px}
.dcard-name{font-family:var(--fh);font-weight:700;font-size:14px}
.dcard-sub{font-size:10px;color:var(--mu);margin-top:2px;line-height:1.5}
.dcard-rest{text-align:right}
.dcard-val{font-family:var(--fh);font-weight:700;font-size:15px;color:var(--err)}
.dcard-of{font-size:10px;color:var(--mu)}
.dcard-badge{display:inline-block;padding:2px 8px;border-radius:20px;font-size:9px;font-weight:600;background:rgba(247,201,72,.1);color:var(--d5);margin-top:3px}
.dcard-acts{display:flex;gap:7px;margin-top:10px}
.btn-dpay{flex:1;padding:8px;border-radius:9px;border:1.5px solid rgba(107,255,184,.25);
  background:rgba(107,255,184,.08);color:var(--ok);font-family:var(--fh);font-weight:700;font-size:12px;cursor:pointer}
.btn-dpay.done{background:rgba(107,255,184,.04);border-style:dashed}
.btn-ddel{width:32px;border-radius:9px;border:none;background:rgba(255,107,107,.08);color:var(--err);cursor:pointer;font-size:13px}
.cx-bal{margin:13px 16px 0;background:var(--sf);border:2px solid rgba(107,255,184,.3);border-radius:var(--r);padding:18px;text-align:center}
.cx-lbl{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--mu);margin-bottom:5px}
.cx-val{font-family:var(--fh);font-size:36px;font-weight:800}
.cx-btns{display:flex;gap:9px;padding:12px 16px}
.btn-cx{flex:1;padding:11px;border-radius:11px;border:none;font-family:var(--fh);font-weight:700;font-size:13px;cursor:pointer;transition:opacity .15s}
.btn-cx:hover{opacity:.85}
.btn-cxin{background:rgba(107,255,184,.12);color:var(--ok);border:1.5px solid rgba(107,255,184,.25)}
.btn-cxout{background:rgba(255,107,107,.1);color:var(--err);border:1.5px solid rgba(255,107,107,.2)}
.gitem{background:var(--sf);border:1px solid var(--bd);border-radius:10px;padding:10px 12px;display:flex;align-items:center;gap:9px;margin-bottom:6px}
.gico{font-size:17px;flex-shrink:0}
.ginfo{flex:1;min-width:0}
.gdesc{font-family:var(--fh);font-weight:600;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.gmeta{font-size:9px;color:var(--mu);margin-top:1px}
.gamt{font-size:13px;font-weight:500;color:var(--err);flex-shrink:0}
.mbg{display:none;position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.8);backdrop-filter:blur(12px);align-items:flex-end;justify-content:center}
.mbg.open{display:flex}
.modal{background:var(--sf2);border:1px solid var(--bd);border-radius:20px 20px 0 0;padding:16px 16px 44px;width:100%;max-width:520px;animation:sup .25s cubic-bezier(.34,1.56,.64,1);max-height:90dvh;overflow-y:auto}
@keyframes sup{from{transform:translateY(100%)}to{transform:translateY(0)}}
.mhandle{width:34px;height:4px;background:var(--bd);border-radius:2px;margin:0 auto 14px}
.mtitle{font-family:var(--fh);font-weight:800;font-size:16px;margin-bottom:13px}
.field{margin-bottom:11px}
.field label{display:block;font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--mu);margin-bottom:4px}
.field input,.field select{width:100%;padding:9px 11px;background:var(--sf);border:1.5px solid var(--bd);border-radius:9px;color:var(--tx);font-family:var(--fm);font-size:14px;outline:none;transition:border-color .2s}
.field input:focus,.field select:focus{border-color:var(--d5)}
.field select option{background:var(--sf2)}
.row2{display:flex;gap:8px}.row2 .field{flex:1}
.ibox{background:rgba(247,201,72,.06);border:1px solid rgba(247,201,72,.2);border-radius:9px;padding:9px 11px;font-size:11px;color:var(--d5);margin-bottom:11px;line-height:1.6}
.ibox.iok{background:rgba(107,255,184,.06);border-color:rgba(107,255,184,.2);color:var(--ok)}
.btn-save{width:100%;padding:11px;border-radius:10px;border:none;background:var(--d5);color:#080810;font-family:var(--fh);font-weight:800;font-size:14px;cursor:pointer;margin-top:4px;transition:opacity .15s}
.btn-save:hover{opacity:.9}
.btn-cancel{width:100%;padding:9px;border-radius:10px;border:1.5px solid var(--bd);background:transparent;color:var(--mu);font-family:var(--fh);font-weight:600;font-size:13px;cursor:pointer;margin-top:6px}
.btn-danger{width:100%;padding:9px;border-radius:10px;border:1.5px solid rgba(255,107,107,.3);background:transparent;color:var(--err);font-family:var(--fh);font-weight:600;font-size:13px;cursor:pointer;margin-top:6px;display:none}
.insight{margin:0 16px 8px;padding:10px 12px;border-radius:0 11px 11px 0;font-size:12px;line-height:1.5}
.insight.iok{background:rgba(107,255,184,.06);border-left:3px solid var(--ok)}
.insight.iwk{background:rgba(247,201,72,.06);border-left:3px solid var(--d5)}
.insight.ier{background:rgba(255,107,107,.07);border-left:3px solid var(--err)}
.ptitle{font-family:var(--fh);font-size:20px;font-weight:800;letter-spacing:-.5px;padding:14px 16px 0}
.ptitle .hl{color:var(--d5)}
.fab{position:fixed;right:16px;bottom:84px;width:50px;height:50px;border-radius:50%;border:none;background:var(--d5);color:#080810;font-size:22px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 18px rgba(247,201,72,.35);z-index:40;transition:transform .15s}
.fab:hover{transform:scale(.95)}
.page{display:none}.page.on{display:block}
.nodebts{text-align:center;padding:40px 20px;color:var(--mu)}
.nodebts .big{font-size:42px;margin-bottom:10px}
</style>
</head>
<body>
<div class="hdr">
  <div class="hdr-logo">&#x1F4B8; Meu <span>Caixa</span></div>
  <div class="hdr-right">
    <div class="mnav">
      <button class="btn-mn" onclick="chM(-1)">&#9664;</button>
      <div class="mlbl" id="mlbl" onclick="goNow()">&#8212;</div>
      <button class="btn-mn" onclick="chM(1)">&#9654;</button>
    </div>
    <button class="btn-ico" onclick="openM('mSettings')">&#9881;&#65039;</button>
  </div>
</div>
<div id="pg-plano" class="page on"></div>
<div id="pg-dividas" class="page"></div>
<div id="pg-gastos" class="page"></div>
<div id="pg-caixinha" class="page"></div>
<div id="pg-dash" class="page"></div>
<button class="fab" id="fab" onclick="fabAct()">&#xFF0B;</button>
<nav class="bnav">
  <button class="bnt on" id="bn-plano" onclick="go('plano')"><span class="ico">&#x1F4C5;</span>Plano</button>
  <button class="bnt" id="bn-dividas" onclick="go('dividas')"><span class="ico">&#x1F4B3;</span>D&#237;vidas</button>
  <button class="bnt" id="bn-gastos" onclick="go('gastos')"><span class="ico">&#x1F4B8;</span>Gastos</button>
  <button class="bnt" id="bn-caixinha" onclick="go('caixinha')"><span class="ico">&#x1F4B0;</span>Caixinha</button>
  <button class="bnt" id="bn-dash" onclick="go('dash')"><span class="ico">&#x1F4CA;</span>Dash</button>
</nav>
<!-- MODALS -->
<div class="mbg" id="mEntry"><div class="modal">
  <div class="mhandle"></div>
  <div class="mtitle" id="mEntryTitle">Novo Lance</div>
  <div class="field"><label>Descri&#231;&#227;o</label><input id="eN" placeholder="Ex: Cart&#227;o, Sal&#225;rio..." autocomplete="off"></div>
  <div class="field" id="eAmtF"><label>Valor (R$)</label><input type="number" id="eAmt" placeholder="0,00" step="0.01" min="0" inputmode="decimal"></div>
  <div class="field"><label>Tipo</label>
    <select id="eType" onchange="onEType()">
      <option value="income">&#x1F4B0; Entrada / Sal&#225;rio</option>
      <option value="fixed" selected>&#x1F512; Despesa Fixa</option>
      <option value="variable">&#x1F4CC; Despesa Pontual</option>
      <option value="vf">&#x26A1; Fixa Valor Vari&#225;vel</option>
    </select></div>
  <div class="field"><label>Dia de Pagamento</label>
    <select id="eDay"><option value="5">Dia 05</option><option value="20">Dia 20</option></select></div>
  <div class="field" id="eRecF"><label>Recorr&#234;ncia</label>
    <select id="eRec"><option value="monthly">Todo m&#234;s</option><option value="once">Apenas este m&#234;s</option></select></div>
  <div class="ibox" id="eInfo" style="display:none"></div>
  <button class="btn-save" onclick="saveEntry()">Salvar</button>
  <button class="btn-cancel" onclick="closeM('mEntry')">Cancelar</button>
</div></div>
<div class="mbg" id="mVF"><div class="modal">
  <div class="mhandle"></div>
  <div class="mtitle" id="mVFTitle">Valor deste M&#234;s</div>
  <div class="field"><label>Valor (R$)</label><input type="number" id="vfAmt" placeholder="0,00" step="0.01" min="0" inputmode="decimal"></div>
  <button class="btn-save" onclick="saveVF()">Salvar</button>
  <button class="btn-cancel" onclick="closeM('mVF')">Cancelar</button>
</div></div>
<div class="mbg" id="mPay"><div class="modal">
  <div class="mhandle"></div>
  <div class="mtitle" id="mPayTitle">Marcar como Pago</div>
  <div class="ibox" id="mPayInfo"></div>
  <div class="field"><label>Valor Pago (R$)</label><input type="number" id="payAmt" step="0.01" min="0" inputmode="decimal"></div>
  <button class="btn-save" onclick="confirmPay()">&#x2713; Confirmar</button>
  <button class="btn-danger" id="btnUnpay" onclick="undoPay()">&#x21A9; Desfazer Pagamento</button>
  <button class="btn-cancel" onclick="closeM('mPay')">Cancelar</button>
</div></div>
<div class="mbg" id="mDebt"><div class="modal">
  <div class="mhandle"></div>
  <div class="mtitle">Nova D&#237;vida</div>
  <div class="field"><label>Nome</label><input id="dN" placeholder="Ex: Empr&#233;stimo, Cart&#227;o..." autocomplete="off"></div>
  <div class="field"><label>Credor / Onde</label><input id="dW" placeholder="Ex: Sogra, Nubank..." autocomplete="off"></div>
  <div class="field"><label>Tipo</label>
    <select id="dKind" onchange="onDKind()">
      <option value="parc">&#x1F4E6; Parcelada</option>
      <option value="open">&#x1F4B3; Em aberto</option>
    </select></div>
  <div id="dParcF">
    <div class="field"><label>Valor Total (R$)</label><input type="number" id="dTotal" placeholder="0,00" step="0.01" min="0" oninput="calcParc()" inputmode="decimal"></div>
    <div class="row2">
      <div class="field"><label>N&#186; Parcelas</label><input type="number" id="dNP" placeholder="12" min="1" step="1" oninput="calcParc()" inputmode="numeric"></div>
      <div class="field"><label>J&#225; Pagas</label><input type="number" id="dPagas" placeholder="0" min="0" step="1" value="0" oninput="calcParc()" inputmode="numeric"></div>
    </div>
    <div class="field"><label>Valor da Parcela (R$)</label><input type="number" id="dParc" placeholder="Calculado auto..." step="0.01" min="0" oninput="calcParcRev()" inputmode="decimal"></div>
    <div class="ibox iok" id="dParcInfo" style="display:none"></div>
  </div>
  <div id="dOpenF" style="display:none">
    <div class="field"><label>Valor Total (R$)</label><input type="number" id="dTotalO" placeholder="0,00" step="0.01" min="0" inputmode="decimal"></div>
    <div class="field"><label>J&#225; Paguei (R$)</label><input type="number" id="dPaidO" placeholder="0,00" step="0.01" min="0" value="0" inputmode="decimal"></div>
    <div class="field"><label>Parcela Mensal (R$)</label><input type="number" id="dMthO" placeholder="0,00" step="0.01" min="0" inputmode="decimal"></div>
  </div>
  <div class="field"><label>Dia de Cobran&#231;a</label>
    <select id="dDay"><option value="5">Dia 05</option><option value="20">Dia 20</option></select></div>
  <div class="row2">
    <div class="field"><label>M&#234;s In&#237;cio</label><select id="dSM"></select></div>
    <div class="field"><label>Ano In&#237;cio</label><input type="number" id="dSY" min="2026" max="2040" step="1" inputmode="decimal"></div>
  </div>
  <div class="row2">
    <div class="field"><label>M&#234;s Fim (opcional)</label><select id="dEM"></select></div>
    <div class="field"><label>Ano Fim</label><input type="number" id="dEY" min="2026" max="2040" step="1" placeholder="&#8212;" inputmode="decimal"></div>
  </div>
  <div class="field"><label>Observa&#231;&#227;o</label><input id="dNote" placeholder="opcional" autocomplete="off"></div>
  <button class="btn-save" onclick="saveDebt()">Salvar D&#237;vida</button>
  <button class="btn-cancel" onclick="closeM('mDebt')">Cancelar</button>
</div></div>
<div class="mbg" id="mDPay"><div class="modal">
  <div class="mhandle"></div>
  <div class="mtitle" id="mDPayTitle">Registrar Pagamento</div>
  <div class="field"><label>Valor (R$)</label><input type="number" id="dpAmt" step="0.01" min="0" inputmode="decimal"></div>
  <div class="field"><label>Observa&#231;&#227;o</label><input id="dpNote" placeholder="opcional" autocomplete="off"></div>
  <button class="btn-save" onclick="saveDPay()">Confirmar</button>
  <button class="btn-cancel" onclick="closeM('mDPay')">Cancelar</button>
</div></div>
<div class="mbg" id="mGasto"><div class="modal">
  <div class="mhandle"></div>
  <div class="mtitle">Gasto do Dia a Dia</div>
  <div class="field"><label>Descri&#231;&#227;o</label><input id="gDesc" placeholder="Ex: Mercado, iFood..." autocomplete="off"></div>
  <div class="field"><label>Valor (R$)</label><input type="number" id="gAmt" placeholder="0,00" step="0.01" min="0" inputmode="decimal"></div>
  <div class="field"><label>Categoria</label>
    <select id="gCat">
      <option>&#x1F6D2; Mercado</option><option>&#x26FD; Combust&#237;vel</option><option>&#x1F48A; Farm&#225;cia</option>
      <option>&#x1F354; Alimenta&#231;&#227;o</option><option>&#x1F3AE; Lazer</option><option>&#x1F455; Roupas</option>
      <option>&#x1F3E0; Casa</option><option>&#x1F68C; Transporte</option><option>&#x1F4A1; Outros</option>
    </select></div>
  <button class="btn-save" onclick="saveGasto()">Salvar</button>
  <button class="btn-cancel" onclick="closeM('mGasto')">Cancelar</button>
</div></div>
<div class="mbg" id="mCx"><div class="modal">
  <div class="mhandle"></div>
  <div class="mtitle" id="mCxTitle">Caixinha</div>
  <div class="field"><label>Descri&#231;&#227;o</label><input id="cxDesc" placeholder="Ex: Sobra do m&#234;s..." autocomplete="off"></div>
  <div class="field"><label>Valor (R$)</label><input type="number" id="cxAmt" placeholder="0,00" step="0.01" min="0" inputmode="decimal"></div>
  <button class="btn-save" id="cxSave" onclick="saveCx()">Salvar</button>
  <button class="btn-cancel" onclick="closeM('mCx')">Cancelar</button>
</div></div>
<div class="mbg" id="mTransf"><div class="modal">
  <div class="mhandle"></div>
  <div class="mtitle">&#x1F4B8; Quanto guardou pro Dia 20?</div>
  <div class="ibox">Valor separado do Dia 05 para cobrir as contas do Dia 20. Sai do saldo do Dia 05 e entra como receita no Dia 20.</div>
  <div class="field"><label>Valor (R$)</label><input type="number" id="trAmt" placeholder="0,00" step="0.01" min="0" inputmode="decimal"></div>
  <button class="btn-save" onclick="saveTransf()">Salvar</button>
  <button class="btn-cancel" onclick="closeM('mTransf')">Cancelar</button>
</div></div>
<div class="mbg" id="mSettings"><div class="modal">
  <div class="mhandle"></div>
  <div class="mtitle">&#9881;&#65039; Configura&#231;&#245;es</div>
  <div class="ibox" style="margin-bottom:13px">
    <strong>Integra&#231;&#227;o Google Sheets:</strong><br>
    1. Crie uma planilha no Google Sheets<br>
    2. Extens&#245;es &#8594; Apps Script &#8594; cole o c&#243;digo .js<br>
    3. Implantar &#8594; Web App &#8594; Acesso: Qualquer pessoa<br>
    4. Copie a URL e cole abaixo
  </div>
  <div class="field"><label>URL do Apps Script</label>
    <input id="cfgUrl" type="url" placeholder="https://script.google.com/macros/s/..."></div>
  <button class="btn-save" onclick="saveCfg()">Salvar</button>
  <div style="height:1px;background:var(--bd);margin:14px 0"></div>
  <div style="font-family:var(--fh);font-weight:700;font-size:12px;color:var(--mu);margin-bottom:8px;letter-spacing:1px">SINCRONIZA&#199;&#195;O</div>
  <button class="btn-save" style="background:var(--d20);color:#080810;margin-bottom:6px" onclick="pushToSheets()">&#x1F4E4; Enviar dados para a planilha</button>
  <button class="btn-save" style="background:rgba(79,209,197,.15);color:var(--d20);border:1.5px solid rgba(79,209,197,.3)" onclick="pullFromSheets()">&#x1F4E5; Importar dados da planilha</button>
  <div id="syncStatus" style="font-size:11px;color:var(--mu);margin-top:8px;text-align:center;min-height:16px"></div>
  <button class="btn-cancel" onclick="closeM('mSettings')">Fechar</button>
</div></div>
<script>
const MN=['Janeiro','Fevereiro','Mar\u00e7o','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
const MS=['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
const MIN_Y=2026,MIN_M=2;
let S,curPage='plano',subDay=5,curY=2026,curM=2;
let _pid=null,_vfId=null,_dpId=null,_cxT=null;

function initS(){return{v:3,entries:[],nextEId:1,debts:[],nextDId:1,debtPays:[],nextDPId:1,gastos:[],nextGId:1,caixinha:[],nextCId:1,vfAmts:{},payments:{},debtMo:{},transfers:{}};}
function seed(s){
  const a=(o)=>{s.entries.push({id:s.nextEId++,...o});};
  a({name:'Sal\u00e1rio (eu)',amount:1500,type:'income',day:5,rec:'monthly'});
  a({name:'Sal\u00e1rio (ela)',amount:1800,type:'income',day:5,rec:'monthly'});
  a({name:'Cart\u00e3o',amount:1240,type:'fixed',day:5,rec:'monthly'});
  a({name:'Sal\u00e1rio (eu)',amount:1050,type:'income',day:20,rec:'monthly'});
  a({name:'Luz',amount:0,type:'vf',day:20,rec:'monthly'});
  a({name:'\u00c1gua',amount:0,type:'vf',day:5,rec:'monthly'});
}
function load(){
  const raw=localStorage.getItem('mc_v3');
  if(raw){try{S=JSON.parse(raw);}catch(e){S=initS();seed(S);}
    ['vfAmts','payments','debtMo','transfers'].forEach(k=>{if(!S[k])S[k]={};});
    ['debtPays','gastos','caixinha','debts','entries'].forEach(k=>{if(!S[k])S[k]=[];});
    ['nextEId','nextDId','nextDPId','nextGId','nextCId'].forEach(k=>{if(!S[k])S[k]=1;});
  } else {
    // migrate from v2
    const old=localStorage.getItem('mc_v2');
    S=initS();
    if(old){try{const o=JSON.parse(old);
      (o.entries||[]).forEach(e=>S.entries.push({id:S.nextEId++,name:e.name,amount:e.amount||0,type:e.type,day:e.day,rec:e.rec||'monthly',month:e.month,year:e.year}));
      (o.debts||[]).forEach(d=>S.debts.push({id:S.nextDId++,name:d.name,who:d.who||'',note:d.note||'',day:d.day||5,kind:d.kind||'parc',total:d.total||0,monthly:d.monthly||0,initialPaid:d.initialPaid||0,nParcelas:d.nParcelas||0,startY:MIN_Y,startM:MIN_M,endY:null,endM:null}));
      (o.debtPays||[]).forEach(p=>{if(p.y>=MIN_Y)S.debtPays.push({id:S.nextDPId++,dId:p.dId,amt:p.amt,_auto:p._auto,date:p.date,y:p.y,m:p.m});});
      (o.gastos||[]).forEach(g=>{if(g.y>MIN_Y||(g.y===MIN_Y&&g.m>=MIN_M))S.gastos.push({id:S.nextGId++,desc:g.desc,amt:g.amt,cat:g.cat,date:g.date,y:g.y,m:g.m});});
      (o.caixinha||[]).forEach(t=>{if(t.y>MIN_Y||(t.y===MIN_Y&&t.m>=MIN_M))S.caixinha.push({id:S.nextCId++,type:t.type,desc:t.desc,amt:t.amt,date:t.date,y:t.y,m:t.m});});
      if(o.vfAmounts)Object.assign(S.vfAmts,o.vfAmounts);
      if(o.transfers)Object.assign(S.transfers,o.transfers);
    }catch(e){seed(S);}}
    else seed(S);
  }
  persist();
}
function persist(){localStorage.setItem('mc_v3',JSON.stringify(S));}

// Keys
const vfK =(id)=>`vf_${id}_${curY}_${curM}`;
const payK=(id)=>`pay_${id}_${curY}_${curM}`;
const dpK =(id)=>`dp_${id}_${curY}_${curM}`;
const trK =()=>`tr_${curY}_${curM}`;

// Payment utils
function isPaid(pid){
  if(pid.startsWith('e_')){const id=+pid.slice(2);return !!(S.payments[payK(id)]);}
  const id=+pid.slice(2);return !!(S.debtMo[dpK(id)]);
}
function paidAmt(pid){
  if(pid.startsWith('e_')){const id=+pid.slice(2);return S.payments[payK(id)]?.amt||0;}
  const id=+pid.slice(2);return S.debtMo[dpK(id)]?.amt||0;
}

// Entry helpers
// Helpers
function planned(e){const v=eAmt(e);return v!=null?v:e.amount||0;}
function eAmt(e){
  if(e.type==='vf'){const v=S.vfAmts[vfK(e.id)];return v!==undefined?v:null;}
  return e.amount;
}
function periodEntries(day){
  const reg=S.entries.filter(e=>{
    if(e.day!=day)return false;
    if(e.rec==='monthly'||e.type==='vf')return true;
    if(e.rec==='once')return e.month===curM&&e.year===curY;
    return false;
  });
  const dv=activeDebts(day).map(d=>({
    _isD:true,_did:d.id,id:`d_${d.id}`,pid:`d_${d.id}`,
    name:d.name+(d.kind==='parc'?' (parcela)':''),
    type:'debt',day:d.day,amount:d.monthly,
    _rem:debtRem(d),_np:d.kind==='parc'?Math.ceil(debtRem(d)/(d.monthly||1)):null
  }));
  return [...reg.map(e=>({...e,pid:`e_${e.id}`})),...dv];
}
function activeDebts(day){
  return S.debts.filter(d=>{
    if(d.day!=day||d.monthly<=0||debtRem(d)<=0)return false;
    const as=(curY>d.startY)||(curY===d.startY&&curM>=d.startM);
    if(!as)return false;
    if(d.endY&&d.endM!==null){const be=(curY<d.endY)||(curY===d.endY&&curM<=d.endM);if(!be)return false;}
    return true;
  });
}
function debtPaidTotal(d){return S.debtPays.filter(p=>p.dId===d.id).reduce((s,p)=>s+p.amt,0)+(d.initialPaid||0);}
function debtRem(d){return Math.max(0,d.total-debtPaidTotal(d));}

// Calcs
function calcPeriod(day){
  const ents=periodEntries(day);
  const inc=ents.filter(e=>e.type==='income');
  const exp=ents.filter(e=>e.type!=='income');
  const totalIn=inc.reduce((s,e)=>s+(eAmt(e)||0),0);
  const totalOut=exp.reduce((s,e)=>s+(planned(e)),0);
  const tr=S.transfers[trK()]||0;
  const bal=day===5?totalIn-totalOut-tr:(totalIn+tr)-totalOut;
  const paidOut=exp.filter(e=>isPaid(e.pid)).reduce((s,e)=>s+paidAmt(e.pid),0);
  const rem=exp.filter(e=>!isPaid(e.pid)).reduce((s,e)=>s+(planned(e)),0);
  const pC=exp.filter(e=>isPaid(e.pid)).length;
  return{ents,inc,exp,totalIn,totalOut,tr,bal,paidOut,rem,pC,tC:exp.length};
}

// Format
function fmt(v){const a=Math.abs(v||0).toFixed(2).replace('.',',').replace(/\B(?=(\d{3})+(?!\d))/g,'.');return(v<0?'-':'')+'R$ '+a;}
function fdate(iso){try{const d=new Date(iso);return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}`;}catch{return '?';}}

// ─── RENDERS ───
function renderPlano(){
  const pg=document.getElementById('pg-plano');
  const day=subDay;
  const{ents,inc,exp,totalIn,totalOut,tr,bal,rem,pC,tC}=calcPeriod(day);
  const fxd=exp.filter(e=>e.type==='fixed');
  const vfs=exp.filter(e=>e.type==='vf');
  const vrs=exp.filter(e=>e.type==='variable');
  const dts=exp.filter(e=>e.type==='debt');
  const ac=bal<0?'aer':bal<200?'awk':'aok';
  const am=`${pC}/${tC} pagas \u00b7 ${bal<0?'Vermelho '+fmt(Math.abs(bal)):'Sobra '+fmt(bal)}`;
  const trSet=tr>0;
  const tw=`<div class="transf-box ${trSet?'tset':''}">
    <div class="trow">
      <div><div class="tlbl">${day===5?'\uD83D\uDCB8 Guardado pro Dia 20':'\uD83D\uDCB0 Recebido do Dia 05'}</div>
        <div class="tsub">${day===5?'Sai do Dia 05 \u00b7 Entra no Dia 20':'Transferido do Dia 05'}</div></div>
      <div class="tval" style="color:${trSet?'var(--sav)':'var(--mu)'}">${trSet?fmt(tr):'\u2014'}</div>
    </div>
    ${day===5?`<div class="tbtns">
      <button class="tbtn" onclick="openTransf()">${trSet?'\u270E Editar':'+ Definir valor'}</button>
      ${trSet?'<button class="tbtn tc" onclick="clearTransf()">&#10005;</button>':''}
    </div>`:''}
  </div>`;
  pg.innerHTML=`
    <div class="tabs">
      <button class="tab ${day===5?'on5':''}" onclick="setDay(5)">DIA 05</button>
      <button class="tab ${day===20?'on20':''}" onclick="setDay(20)">DIA 20</button>
    </div>
    <div class="alert ${ac}">${am}</div>
    <div class="cards">
      <div class="card"><div class="clbl">Sal\u00e1rios</div><div class="cval vok">${fmt(totalIn)}</div><div class="csub">${inc.map(e=>e.name.replace('Sal\u00e1rio ','')).join(' + ')}</div></div>
      ${day===20&&trSet?`<div class="card cd5"><div class="clbl">+ Recebido Dia 05</div><div class="cval vd5">${fmt(tr)}</div></div>`:''}
      <div class="card"><div class="clbl">Contas</div><div class="cval verr">${fmt(totalOut)}</div></div>
      ${day===5&&trSet?`<div class="card csav"><div class="clbl">Transferido D20</div><div class="cval vsav">- ${fmt(tr)}</div></div>`:''}
      <div class="card full ${bal>=0?'cok':'cerr'}"><div class="clbl">${day===5?'Saldo Dia 05':'Saldo Final Dia 20'}</div><div class="cval ${bal>=0?'vok':'verr'}">${fmt(bal)}</div></div>
      ${rem>0?`<div class="card full"><div class="clbl">A Pagar Ainda</div><div class="cval verr">${fmt(rem)}</div><div class="csub">${tC-pC} conta(s) pendente(s)</div></div>`:''}
    </div>
    ${tw}
    ${sec('\uD83D\uDD12 Despesas Fixas',fxd,day,'fixed',true)}
    ${vfs.length?sec('\u26A1 Valor Vari\u00e1vel',vfs,day,'vf',false):''}
    ${dts.length?sec('\uD83D\uDCB3 D\u00edvidas do M\u00eas',dts,day,null,false):''}
    ${sec('\uD83D\uDCCC Pontuais',vrs,day,'variable',false)}`;
}
function sec(label,items,day,addType,showAll){
  const acts=`<div class="sec-acts">
    ${showAll&&items.length?`<button class="btn-sm" onclick="payAll('${addType}',${day})">&#x2713; Todas</button>`:''}
    ${addType?`<button class="btn-add" onclick="openEntry('${addType}',${day})">+</button>`:''}
  </div>`;
  return `<div class="sec"><div class="sec-hdr"><div class="sec-lbl">${label}</div>${acts}</div>
    <div class="ilist">${items.map(e=>itemH(e)).join('')||'<div class="empty">Nenhum item</div>'}</div></div>`;
}
function itemH(e){
  const paid=isPaid(e.pid);
  const pl=planned(e);
  const pa=paidAmt(e.pid);
  const isInc=e.type==='income',isDbt=e.type==='debt',isVF=e.type==='vf';
  const ico={income:'\uD83D\uDCB0',fixed:'\uD83D\uDD12',variable:'\uD83D\uDCCC',vf:'\u26A1',debt:'\uD83D\uDCB3'};
  const tags={fixed:'FIXA',variable:'PONTUAL',vf:'VAR',debt:'D\u00cdVIDA'};
  let amtH;
  if(isVF&&pl===null)amtH=`<div class="iamt vmu">Definir &#9658;</div>`;
  else if(paid)amtH=`<div class="iamt vok">\u2713 ${fmt(pa)}</div>`;
  else amtH=`<div class="iamt ${isInc?'vok':'verr'}">${isInc?'+':'\u2212'}${fmt(pl)}</div>`;
  const dSub=isDbt&&e._rem!==undefined?`<span>${fmt(e._rem)} restante${e._np?' \u00b7 '+e._np+'x':''}</span>`:'';
  const editB=isVF?`<button class="btn-edit" onclick="openVF(${e.id},'${e.name.replace(/'/g,"\\'")}')">&#9998;</button>`:'';
  const payB=!isInc?`<button class="btn-pay ${paid?'done':''}" onclick="openPay('${e.pid}','${e.name.replace(/'/g,"\\'")}',${pl})">${paid?'&#x2713;':''}</button>`:'';
  const delB=!isDbt?`<button class="btn-del" onclick="delEntry(${e.id})">&#10005;</button>`:'';
  return `<div class="itm ${paid?'pd':''}">
    <div class="iico t${e.type||'fixed'}">${ico[e.type]||'\uD83D\uDCCC'}</div>
    <div class="iinfo">
      <div class="iname">${e.name}</div>
      <div class="imeta">${tags[e.type]?`<span class="tag t${e.type}">${tags[e.type]}</span>`:''}${dSub}${paid&&pa!==pl?`<span style="color:var(--d5);font-size:9px">plan. ${fmt(pl)}</span>`:''}</div>
    </div>
    <div class="iright">${amtH}${editB}${payB}${delB}</div>
  </div>`;
}
function renderDividas(){
  const pg=document.getElementById('pg-dividas');
  const tRest=S.debts.reduce((s,d)=>s+debtRem(d),0);
  const tTotal=S.debts.reduce((s,d)=>s+d.total,0);
  const tPago=S.debts.reduce((s,d)=>s+debtPaidTotal(d),0);
  const pct=tTotal>0?Math.min(100,Math.round(tPago/tTotal*100)):0;
  const cards=S.debts.map(d=>{
    const paid=debtPaidTotal(d),rest=Math.max(0,d.total-paid),p=d.total>0?Math.min(100,Math.round(paid/d.total*100)):0;
    const done=rest<=0;const mRest=d.monthly>0?Math.ceil(rest/d.monthly):null;
    const thisMo=!!(S.debtMo[dpK(d.id)]);
    const period=`${MS[d.startM]} ${d.startY}`+(d.endM!=null&&d.endY?` \u2192 ${MS[d.endM]} ${d.endY}`:'');
    return `<div class="dcard ${done?'ddone':''}">
      <div class="dcard-hdr">
        <div><div class="dcard-name">${d.name} ${done?'\u2713':''}</div>
          <div class="dcard-sub">${d.who} \u00b7 Dia ${String(d.day).padStart(2,'0')}<br>${period}${d.note?' \u00b7 '+d.note:''}</div>
          ${d.kind==='parc'&&!done?`<div class="dcard-badge">${mRest?mRest+'x de '+fmt(d.monthly):''} restantes</div>`:''}
        </div>
        <div class="dcard-rest"><div class="dcard-val">${fmt(rest)}</div><div class="dcard-of">de ${fmt(d.total)}</div></div>
      </div>
      <div style="background:var(--sf2);border:1px solid var(--bd);border-radius:9px;padding:9px">
        <div class="pbar-hdr" style="margin-bottom:6px">
          <div style="font-size:10px;color:var(--mu)">Pago ${fmt(paid)}</div>
          <div style="font-size:10px;color:var(--mu)">${p}%</div>
        </div>
        <div class="track"><div class="fill ${p>50?'f-ok':'f-err'}" style="width:${p}%"></div></div>
      </div>
      <div class="dcard-acts">
        ${!done?`<button class="btn-dpay ${thisMo?'done':''}" onclick="openDPay(${d.id},'${d.name.replace(/'/g,"\\'")}',${d.monthly||0})">${thisMo?'\u2713 Parcela de '+MS[curM]+' paga':'+ Registrar / Pagar'}</button>`:'<button class="btn-dpay done" disabled>Quitada \u2713</button>'}
        <button class="btn-ddel" onclick="delDebt(${d.id})">&#10005;</button>
      </div>
    </div>`;
  }).join('');
  pg.innerHTML=`<div class="ptitle">&#x1F4B3; <span class="hl">D\u00edvidas</span></div>
    ${S.debts.length?`<div class="cards"><div class="card full ${tRest>0?'cerr':'cok'}"><div class="clbl">Total em Aberto</div><div class="cval ${tRest>0?'verr':'vok'}">${fmt(tRest)}</div><div class="csub">${S.debts.filter(d=>debtRem(d)>0).length} ativa(s) \u00b7 ${fmt(tPago)} j\u00e1 pago</div></div></div>
    <div class="pbar-wrap"><div class="pbar-hdr"><div class="pbar-ttl">Progresso Geral</div><div class="pbar-pct">${pct}%</div></div><div class="track"><div class="fill f-ok" style="width:${pct}%"></div></div><div class="pbar-sub"><span>${fmt(tPago)} pago</span><span>${fmt(tTotal)} total</span></div></div>
    ${cards}`:'<div class="nodebts"><div class="big">\uD83C\uDF89</div><p style="font-size:12px;line-height:1.7">Nenhuma d\u00edvida cadastrada.</p></div>'}`;
}
function renderGastos(){
  const pg=document.getElementById('pg-gastos');
  const gs=S.gastos.filter(g=>g.y===curY&&g.m===curM);
  const total=gs.reduce((s,g)=>s+g.amt,0);
  const byCat={};gs.forEach(g=>{if(!byCat[g.cat])byCat[g.cat]=0;byCat[g.cat]+=g.amt;});
  const cRows=Object.entries(byCat).sort((a,b)=>b[1]-a[1]).map(([cat,amt])=>{
    const pct=total>0?Math.min(100,Math.round(amt/total*100)):0;
    return `<div class="gitem"><div class="gico">${cat.split(' ')[0]}</div><div class="ginfo"><div class="gdesc">${cat.substring(2)}</div><div class="track" style="height:4px;margin-top:4px"><div class="fill f-ok" style="width:${pct}%;opacity:.7"></div></div></div><div class="gamt">${fmt(amt)}</div></div>`;
  }).join('');
  const hist=[...gs].reverse().map(g=>`<div class="gitem"><div class="gico">${g.cat.split(' ')[0]}</div><div class="ginfo"><div class="gdesc">${g.desc}</div><div class="gmeta">${g.cat.substring(2)} \u00b7 ${fdate(g.date)}</div></div><div style="display:flex;align-items:center;gap:5px"><div class="gamt">${fmt(g.amt)}</div><button class="btn-del" onclick="delGasto(${g.id})">&#10005;</button></div></div>`).join('');
  pg.innerHTML=`<div class="ptitle">&#x1F4B8; <span class="hl">Gastos</span></div>
    <div class="cards"><div class="card full"><div class="clbl">Total em ${MS[curM]}</div><div class="cval verr">${fmt(total)}</div><div class="csub">${gs.length} lan\u00e7amento(s)</div></div></div>
    ${Object.keys(byCat).length>1?`<div class="sec"><div class="sec-hdr"><div class="sec-lbl">Por Categoria</div></div>${cRows}</div>`:''}
    <div class="sec"><div class="sec-hdr"><div class="sec-lbl">Hist\u00f3rico de ${MS[curM]}</div></div>${hist||'<div class="empty">Nenhum gasto lan\u00e7ado</div>'}</div>`;
}
function renderCaixinha(){
  const pg=document.getElementById('pg-caixinha');
  const bal=S.caixinha.reduce((s,t)=>s+(t.type==='in'?t.amt:-t.amt),0);
  const mTx=S.caixinha.filter(t=>t.y===curY&&t.m===curM);
  const mIn=mTx.filter(t=>t.type==='in').reduce((s,t)=>s+t.amt,0);
  const mOut=mTx.filter(t=>t.type==='out').reduce((s,t)=>s+t.amt,0);
  const hist=[...S.caixinha].reverse().slice(0,40).map(t=>`<div class="itm"><div class="iico ${t.type==='in'?'tincome':'tvf'}">${t.type==='in'?'\uD83D\uDCB0':'\uD83D\uDCB8'}</div><div class="iinfo"><div class="iname">${t.desc}</div><div class="imeta">${fdate(t.date)} \u00b7 ${MS[t.m]}/${t.y}</div></div><div class="iright"><div class="iamt ${t.type==='in'?'vok':'verr'}">${t.type==='in'?'+':'-'}${fmt(t.amt)}</div><button class="btn-del" onclick="delCx(${t.id})">&#10005;</button></div></div>`).join('');
  pg.innerHTML=`<div class="ptitle">&#x1F4B0; <span class="hl">Caixinha</span></div>
    <div class="cx-bal"><div class="cx-lbl">Saldo Guardado</div><div class="cx-val" style="color:${bal>=0?'var(--ok)':'var(--err)'}">${fmt(bal)}</div></div>
    <div class="cx-btns"><button class="btn-cx btn-cxin" onclick="openCx('in')">\uD83D\uDCB0 Guardar</button><button class="btn-cx btn-cxout" onclick="openCx('out')">\uD83D\uDCB8 Usar</button></div>
    <div class="cards" style="padding-top:0">
      <div class="card ${mIn>0?'cok':''}"><div class="clbl">Guardado em ${MS[curM]}</div><div class="cval vok">${fmt(mIn)}</div></div>
      <div class="card ${mOut>0?'cerr':''}"><div class="clbl">Usado em ${MS[curM]}</div><div class="cval verr">${fmt(mOut)}</div></div>
    </div>
    <div class="sec"><div class="sec-hdr"><div class="sec-lbl">Hist\u00f3rico</div></div><div class="ilist">${hist||'<div class="empty">Nenhuma movimenta\u00e7\u00e3o</div>'}</div></div>`;
}
function renderDash(){
  const pg=document.getElementById('pg-dash');
  const c5=calcPeriod(5),c20=calcPeriod(20),tr=S.transfers[trK()]||0;
  const gasT=S.gastos.filter(g=>g.y===curY&&g.m===curM).reduce((s,g)=>s+g.amt,0);
  const cxB=S.caixinha.reduce((s,t)=>s+(t.type==='in'?t.amt:-t.amt),0);
  const dR=S.debts.reduce((s,d)=>s+debtRem(d),0);
  const tPl=c5.totalOut+c20.totalOut,tPd=c5.paidOut+c20.paidOut;
  const pct=tPl>0?Math.min(100,Math.round(tPd/tPl*100)):0;
  const p5=c5.exp.filter(e=>!isPaid(e.pid)),p20=c20.exp.filter(e=>!isPaid(e.pid));
  const ins=[];
  if(c5.bal<0)ins.push({t:'ier',m:`\u26a0\ufe0f Dia 05 no vermelho \u2014 falta ${fmt(Math.abs(c5.bal))}`});
  if(c20.bal<0)ins.push({t:'ier',m:`\u26a0\ufe0f Dia 20 no vermelho \u2014 falta ${fmt(Math.abs(c20.bal))}`});
  if(!tr)ins.push({t:'iwk',m:`\uD83D\uDCB8 Transfer\u00eancia para Dia 20 n\u00e3o definida`});
  if(cxB>0)ins.push({t:'iok',m:`\uD83D\uDCB0 Caixinha com ${fmt(cxB)} dispon\u00edvel`});
  if(dR>0)ins.push({t:'iwk',m:`\uD83D\uDCB3 ${fmt(dR)} em d\u00edvidas`});
  if(pct===100)ins.push({t:'iok',m:`\u2713 Todas as contas de ${MS[curM]} est\u00e3o pagas! \uD83C\uDF89`});
  pg.innerHTML=`<div class="ptitle" style="display:flex;align-items:center;justify-content:space-between;padding-right:16px">
    <div>&#x1F4CA; <span class="hl">Dashboard</span></div>
    <div style="display:flex;gap:6px">
      <button onclick="syncSheets()" id="syncBtn" class="btn-sm" style="padding:7px 12px;font-size:11px">&#x1F4E4; Sync</button>
      <button onclick="openReport()" class="btn-sm" style="padding:7px 12px;font-size:11px;border-color:var(--sav);color:var(--sav)">&#x1F4CB; Relat&#243;rio</button>
    </div>
  </div>
  <div class="pbar-wrap" style="margin-top:13px"><div class="pbar-hdr"><div class="pbar-ttl">Contas Pagas em ${MS[curM]}</div><div class="pbar-pct">${pct}%</div></div><div class="track"><div class="fill f-ok" style="width:${pct}%"></div></div><div class="pbar-sub"><span>${fmt(tPd)} pago</span><span>${fmt(tPl)} planejado</span></div></div>
  <div class="cards">
    <div class="card ${c5.bal>=0?'cok':'cerr'}"><div class="clbl" style="color:var(--d5)">Saldo Dia 05</div><div class="cval ${c5.bal>=0?'vok':'verr'}">${fmt(c5.bal)}</div><div class="csub">${fmt(c5.totalIn)} sal \u2212 ${fmt(c5.totalOut)} contas${tr?' \u2212 '+fmt(tr)+' D20':''}</div></div>
    <div class="card ${c20.bal>=0?'cok':'cerr'}"><div class="clbl" style="color:var(--d20)">Saldo Dia 20</div><div class="cval ${c20.bal>=0?'vok':'verr'}">${fmt(c20.bal)}</div><div class="csub">${fmt(c20.totalIn)} sal${tr?' + '+fmt(tr)+' D05':''} \u2212 ${fmt(c20.totalOut)} contas</div></div>
    <div class="card ${c20.bal>=0?'cok':'cerr'} full"><div class="clbl">Saldo Real do M\u00eas</div><div class="cval ${c20.bal>=0?'vok':'verr'}">${fmt(c20.bal)}</div></div>
    <div class="card"><div class="clbl">&#x1F4B8; Gastos D.a.D.</div><div class="cval verr">${fmt(gasT)}</div><div class="csub">${S.gastos.filter(g=>g.y===curY&&g.m===curM).length} lan\u00e7amentos</div></div>
    <div class="card csav"><div class="clbl">&#x1F4B0; Caixinha</div><div class="cval ${cxB>=0?'vok':'verr'}">${fmt(cxB)}</div><div class="csub">saldo acumulado</div></div>
  </div>
  ${ins.map(i=>`<div class="insight ${i.t}">${i.m}</div>`).join('')}
  ${p5.length+p20.length>0?`<div class="sec"><div class="sec-hdr"><div class="sec-lbl">\u23F3 Pendentes do M\u00eas</div></div><div class="ilist">
    ${[...p5,...p20].map(e=>`<div class="itm"><div class="iico ${e.type==='debt'?'tdebt':'tfixed'}">${e.type==='debt'?'\uD83D\uDCB3':'\uD83D\uDD12'}</div><div class="iinfo"><div class="iname">${e.name}</div><div class="imeta">Dia ${String(e.day).padStart(2,'0')}</div></div><div class="iright"><div class="iamt verr">\u2212${fmt(e.amount||0)}</div><button class="btn-pay" onclick="openPay('${e.pid}','${e.name.replace(/'/g,"\\'")}',${e.amount||0})"></button></div></div>`).join('')}
  </div></div>`:''}`;
}

// ─── MODAL ACTIONS ───
function openEntry(type,day){
  document.getElementById('eN').value='';document.getElementById('eAmt').value='';
  document.getElementById('eType').value=type||'fixed';document.getElementById('eDay').value=day||subDay;
  onEType();openM('mEntry');setTimeout(()=>document.getElementById('eN').focus(),320);
}
function onEType(){
  const t=document.getElementById('eType').value;
  const info=document.getElementById('eInfo'),amtF=document.getElementById('eAmtF'),recF=document.getElementById('eRecF');
  if(t==='vf'){amtF.style.display='none';recF.style.display='none';info.style.display='block';info.textContent='\u26A1 Aparece todo m\u00eas \u2014 voc\u00ea define o valor a cada m\u00eas (ex: Luz, \u00c1gua).';}
  else{amtF.style.display='block';recF.style.display='block';info.style.display='none';document.getElementById('eRec').value=t==='variable'?'once':'monthly';}
}
function saveEntry(){
  const name=document.getElementById('eN').value.trim();
  const type=document.getElementById('eType').value;
  const day=parseInt(document.getElementById('eDay').value);
  const rec=document.getElementById('eRecF').style.display==='none'?'monthly':document.getElementById('eRec').value;
  if(!name)return;
  let amount=0;if(type!=='vf')amount=parseFloat(document.getElementById('eAmt').value)||0;
  const e={id:S.nextEId++,name,amount,type,day,rec};
  if(rec==='once'){e.month=curM;e.year=curY;}
  S.entries.push(e);persist();closeM('mEntry');render();
}
function delEntry(id){
  if(!confirm('Remover?'))return;
  S.entries=S.entries.filter(e=>e.id!==id);
  // clean orphaned payment and vf keys
  Object.keys(S.payments).forEach(k=>{if(k.includes(`_${id}_`))delete S.payments[k];});
  Object.keys(S.vfAmts).forEach(k=>{if(k.startsWith(`vf_${id}_`))delete S.vfAmts[k];});
  persist();render();
}

function openVF(id,name){
  _vfId=id;document.getElementById('mVFTitle').textContent=name+' \u2014 '+MS[curM];
  const cur=S.vfAmts[vfK(id)];document.getElementById('vfAmt').value=cur!==undefined?cur:'';
  openM('mVF');setTimeout(()=>document.getElementById('vfAmt').focus(),320);
}
function saveVF(){
  const v=parseFloat(document.getElementById('vfAmt').value);if(isNaN(v)||v<0)return;
  S.vfAmts[vfK(_vfId)]=v;persist();closeM('mVF');render();
}

function openPay(pid,name,planned){
  _pid=pid;const paid=isPaid(pid);
  document.getElementById('mPayTitle').textContent=(paid?'\u270E Editar: ':'\u2713 Pagar: ')+name;
  document.getElementById('mPayInfo').textContent='Valor planejado: '+fmt(planned);
  document.getElementById('payAmt').value=paid?paidAmt(pid):(planned||'');
  document.getElementById('btnUnpay').style.display=paid?'block':'none';
  openM('mPay');setTimeout(()=>{const el=document.getElementById('payAmt');el.focus();el.select();},320);
}
function confirmPay(){
  const v=parseFloat(document.getElementById('payAmt').value);if(isNaN(v)||v<0)return;
  if(_pid.startsWith('e_')){
    S.payments[payK(+_pid.slice(2))]={amt:v};
  } else {
    const did=+_pid.slice(2),dk=dpK(did);
    // remove previous auto-pay this month
    const prev=S.debtMo[dk];
    if(prev){let i=-1;S.debtPays.forEach((p,j)=>{if(p.dId===did&&p.y===curY&&p.m===curM&&p._auto)i=j;});if(i>=0)S.debtPays.splice(i,1);}
    S.debtMo[dk]={amt:v};
    S.debtPays.push({id:S.nextDPId++,dId:did,amt:v,_auto:true,date:new Date().toISOString(),y:curY,m:curM});
  }
  persist();closeM('mPay');render();
}
function undoPay(){
  if(_pid.startsWith('e_')){
    delete S.payments[payK(+_pid.slice(2))];
  } else {
    const did=+_pid.slice(2),dk=dpK(did);
    delete S.debtMo[dk];
    let i=-1;S.debtPays.forEach((p,j)=>{if(p.dId===did&&p.y===curY&&p.m===curM&&p._auto)i=j;});
    if(i>=0)S.debtPays.splice(i,1);
  }
  persist();closeM('mPay');render();
}
function payAll(type,day){
  periodEntries(day).filter(e=>e.type===type&&!isPaid(e.pid)).forEach(e=>{
    const v=planned(e);
    if(v>0)S.payments[payK(+e.pid.slice(2))]={amt:v};
  });persist();render();
}
function openTransf(){const cur=S.transfers[trK()]||'';document.getElementById('trAmt').value=cur;openM('mTransf');setTimeout(()=>document.getElementById('trAmt').focus(),320);}
function saveTransf(){const v=parseFloat(document.getElementById('trAmt').value);if(isNaN(v)||v<0)return;S.transfers[trK()]=v;persist();closeM('mTransf');render();}
function clearTransf(){if(!confirm('Limpar transfer\u00eancia deste m\u00eas?'))return;delete S.transfers[trK()];persist();render();}

function populateMSels(){
  ['dSM','dEM'].forEach(id=>{
    const sel=document.getElementById(id),isEnd=id==='dEM';
    sel.innerHTML=isEnd?'<option value="">\u2014 Autom\u00e1tico \u2014':'';
    MN.forEach((n,i)=>{sel.innerHTML+=`<option value="${i}">${n}</option>`;});
  });
}
function onDKind(){const k=document.getElementById('dKind').value;document.getElementById('dParcF').style.display=k==='parc'?'':'none';document.getElementById('dOpenF').style.display=k==='open'?'':'none';}
function calcParc(){
  const t=parseFloat(document.getElementById('dTotal').value)||0,n=parseInt(document.getElementById('dNP').value)||0;
  if(t>0&&n>0){const p=t/n;document.getElementById('dParc').value=p.toFixed(2);showPI(t,n,p);}
}
function calcParcRev(){
  const p=parseFloat(document.getElementById('dParc').value)||0,n=parseInt(document.getElementById('dNP').value)||0;
  if(p>0&&n>0){document.getElementById('dTotal').value=(p*n).toFixed(2);showPI(p*n,n,p);}
}
function showPI(t,n,p){
  const pg=parseInt(document.getElementById('dPagas').value)||0,rest=Math.max(0,n-pg),info=document.getElementById('dParcInfo');
  info.style.display='block';info.textContent=`${pg} paga(s) \u00b7 ${rest} restante(s) de ${fmt(p)} = ${fmt(p*rest)} a pagar`;
}
function openDebt(){
  populateMSels();
  ['dN','dW','dNote'].forEach(id=>document.getElementById(id).value='');
  ['dTotal','dNP','dParc','dTotalO','dPaidO','dMthO','dEY'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('dPagas').value='0';document.getElementById('dKind').value='parc';
  document.getElementById('dDay').value='5';document.getElementById('dSM').value=String(curM);
  document.getElementById('dSY').value=String(curY);document.getElementById('dEM').value='';
  document.getElementById('dParcInfo').style.display='none';onDKind();openM('mDebt');
  setTimeout(()=>document.getElementById('dN').focus(),320);
}
function saveDebt(){
  const name=document.getElementById('dN').value.trim(),who=document.getElementById('dW').value.trim();
  const kind=document.getElementById('dKind').value,day=parseInt(document.getElementById('dDay').value);
  const note=document.getElementById('dNote').value.trim();
  const startM=parseInt(document.getElementById('dSM').value),startY=parseInt(document.getElementById('dSY').value)||curY;
  const emv=document.getElementById('dEM').value,endM=emv!==''?parseInt(emv):null;
  const endY=endM!==null?(parseInt(document.getElementById('dEY').value)||null):null;
  if(!name)return;
  let d={id:S.nextDId++,name,who,note,day,kind,startM,startY,endM,endY};
  if(kind==='parc'){
    const total=parseFloat(document.getElementById('dTotal').value)||0,nP=parseInt(document.getElementById('dNP').value)||0;
    const parc=parseFloat(document.getElementById('dParc').value)||0,pagas=parseInt(document.getElementById('dPagas').value)||0;
    if(total<=0||nP<=0)return;
    d.total=total;d.nParcelas=nP;d.monthly=parc||(total/nP);d.initialPaid=pagas*d.monthly;
    if(endM===null){const ed=new Date(startY,startM+(nP-pagas)-1);d.endM=ed.getMonth();d.endY=ed.getFullYear();}
  } else {
    const total=parseFloat(document.getElementById('dTotalO').value)||0;if(total<=0)return;
    d.total=total;d.monthly=parseFloat(document.getElementById('dMthO').value)||0;
    d.initialPaid=parseFloat(document.getElementById('dPaidO').value)||0;
  }
  S.debts.push(d);persist();closeM('mDebt');render();
}
function delDebt(id){
  if(!confirm('Remover esta d\u00edvida e todos os pagamentos?'))return;
  S.debts=S.debts.filter(d=>d.id!==id);S.debtPays=S.debtPays.filter(p=>p.dId!==id);
  Object.keys(S.debtMo).forEach(k=>{if(k.startsWith(`dp_${id}_`))delete S.debtMo[k];});
  persist();render();
}
function openDPay(did,name,sug){
  _dpId=did;document.getElementById('mDPayTitle').textContent='Pagar: '+name;
  document.getElementById('dpAmt').value=sug||'';document.getElementById('dpNote').value='';
  openM('mDPay');setTimeout(()=>document.getElementById('dpAmt').focus(),320);
}
function saveDPay(){
  const v=parseFloat(document.getElementById('dpAmt').value);if(isNaN(v)||v<=0)return;
  const dk=dpK(_dpId),prev=S.debtMo[dk];
  if(prev){let i=-1;S.debtPays.forEach((p,j)=>{if(p.dId===_dpId&&p.y===curY&&p.m===curM&&p._auto)i=j;});if(i>=0)S.debtPays.splice(i,1);}
  S.debtMo[dk]={amt:v};
  S.debtPays.push({id:S.nextDPId++,dId:_dpId,amt:v,note:document.getElementById('dpNote').value.trim(),_auto:true,date:new Date().toISOString(),y:curY,m:curM});
  persist();closeM('mDPay');render();
}
function openGasto(){document.getElementById('gDesc').value='';document.getElementById('gAmt').value='';openM('mGasto');setTimeout(()=>document.getElementById('gDesc').focus(),320);}
function saveGasto(){
  const desc=document.getElementById('gDesc').value.trim(),amt=parseFloat(document.getElementById('gAmt').value)||0;
  const cat=document.getElementById('gCat').value;if(!desc||amt<=0)return;
  S.gastos.push({id:S.nextGId++,desc,amt,cat,date:new Date().toISOString(),y:curY,m:curM});persist();closeM('mGasto');render();
}
function delGasto(id){if(!confirm('Remover?'))return;S.gastos=S.gastos.filter(g=>g.id!==id);persist();render();}
function openCx(type){
  _cxT=type;document.getElementById('mCxTitle').textContent=type==='in'?'\uD83D\uDCB0 Guardar na Caixinha':'\uD83D\uDCB8 Usar da Caixinha';
  document.getElementById('cxSave').textContent=type==='in'?'\u2713 Guardar':'\u2713 Confirmar';
  document.getElementById('cxDesc').value='';document.getElementById('cxAmt').value='';
  openM('mCx');setTimeout(()=>document.getElementById('cxDesc').focus(),320);
}
function saveCx(){
  const desc=document.getElementById('cxDesc').value.trim(),amt=parseFloat(document.getElementById('cxAmt').value)||0;
  if(!desc||amt<=0)return;S.caixinha.push({id:S.nextCId++,type:_cxT,desc,amt,date:new Date().toISOString(),y:curY,m:curM});persist();closeM('mCx');render();
}
function delCx(id){if(!confirm('Remover?'))return;S.caixinha=S.caixinha.filter(t=>t.id!==id);persist();render();}
function saveCfg(){localStorage.setItem('cfg_url',document.getElementById('cfgUrl').value.trim());closeM('mSettings');}

// ─── NAV ───
function go(page){
  curPage=page;
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('on'));
  document.getElementById('pg-'+page).classList.add('on');
  document.querySelectorAll('.bnt').forEach(b=>b.classList.remove('on'));
  document.getElementById('bn-'+page).classList.add('on');
  const fab=document.getElementById('fab');
  fab.style.display=page==='dash'?'none':'flex';
  render();
}
function fabAct(){
  if(curPage==='plano')openEntry('fixed',subDay);
  else if(curPage==='dividas')openDebt();
  else if(curPage==='gastos')openGasto();
  else if(curPage==='caixinha')openCx('in');
}
function setDay(d){subDay=d;render();}
function chM(dir){
  curM+=dir;if(curM>11){curM=0;curY++;}if(curM<0){curM=11;curY--;}
  if(curY<MIN_Y||(curY===MIN_Y&&curM<MIN_M)){curY=MIN_Y;curM=MIN_M;}
  render();
}
function goNow(){const n=new Date();curM=n.getMonth();curY=n.getFullYear();if(curY<MIN_Y||(curY===MIN_Y&&curM<MIN_M)){curY=MIN_Y;curM=MIN_M;}render();}

// ─── MODALS ───
function openM(id){document.getElementById(id).classList.add('open');}
function closeM(id){document.getElementById(id).classList.remove('open');}
document.querySelectorAll('.mbg').forEach(bg=>bg.addEventListener('click',e=>{if(e.target===bg)bg.classList.remove('open');}));

// ─── SYNC ───
function buildPayload(){
  const c5=calcPeriod(5),c20=calcPeriod(20),tr=S.transfers[trK()]||0;
  return{mes:MN[curM]+' '+curY,
    resumo:{in5:c5.totalIn,out5:c5.totalOut,transf:tr,bal5:c5.bal,in20:c20.totalIn,out20:c20.totalOut,bal20:c20.bal,
      gastos:S.gastos.filter(g=>g.y===curY&&g.m===curM).reduce((s,g)=>s+g.amt,0),
      caixinha:S.caixinha.reduce((s,t)=>s+(t.type==='in'?t.amt:-t.amt),0),
      dividas:S.debts.reduce((s,d)=>s+debtRem(d),0)},
    dia05:c5.exp.map(e=>({name:e.name,type:e.type,planned:planned(e),paid:isPaid(e.pid),paidAmt:paidAmt(e.pid)})),
    dia20:c20.exp.map(e=>({name:e.name,type:e.type,planned:planned(e),paid:isPaid(e.pid),paidAmt:paidAmt(e.pid)})),
    gastos:S.gastos.filter(g=>g.y===curY&&g.m===curM).map(g=>({date:fdate(g.date),cat:g.cat,desc:g.desc,amt:g.amt})),
    dividas:S.debts.map(d=>({name:d.name,who:d.who,kind:d.kind,note:d.note,day:d.day,total:d.total,paid:debtPaidTotal(d),remaining:debtRem(d),monthly:d.monthly,startM:d.startM,startY:d.startY,endM:d.endM,endY:d.endY,nParcelas:d.nParcelas||0})),
    caixinha:S.caixinha.filter(t=>t.y===curY&&t.m===curM).map(t=>({date:fdate(t.date),type:t.type,desc:t.desc,amt:t.amt})),
    _state: JSON.stringify(S)  // full state backup
  };
}

function setSyncStatus(msg,color){
  const el=document.getElementById('syncStatus');
  if(el){el.textContent=msg;el.style.color=color||'var(--mu)';}
}

async function pushToSheets(){
  const url=localStorage.getItem('cfg_url');if(!url){openM('mSettings');return;}
  const btn=document.getElementById('syncBtn');
  if(btn){btn.textContent='\u23F3 Enviando...';btn.disabled=true;}
  setSyncStatus('Enviando...','var(--d5)');
  try{
    await fetch(url,{method:'POST',mode:'no-cors',headers:{'Content-Type':'application/json'},body:JSON.stringify(buildPayload())});
    if(btn){btn.textContent='\u2705 Enviado!';}
    setSyncStatus('\u2705 Dados enviados com sucesso!','var(--ok)');
  }catch(err){
    if(btn){btn.textContent='\u274C Erro';}
    setSyncStatus('\u274C Erro ao enviar: '+err.message,'var(--err)');
  }finally{
    setTimeout(()=>{if(btn){btn.textContent='\uD83D\uDCE4 Sincronizar';btn.disabled=false;}},3500);
  }
}
// alias for dashboard button
function syncSheets(){pushToSheets();}

async function pullFromSheets(){
  const url=localStorage.getItem('cfg_url');
  if(!url){setSyncStatus('Configure a URL primeiro','var(--err)');return;}
  setSyncStatus('Buscando dados...','var(--d5)');
  try{
    // Apps Script GET returns the full state
    const res=await fetch(url+'?action=pull',{method:'GET'});
    if(!res.ok)throw new Error('HTTP '+res.status);
    const data=await res.json();
    if(!data.ok)throw new Error(data.msg||'Erro desconhecido');
    if(!data.state)throw new Error('Planilha sem backup salvo. Envie os dados primeiro pelo dispositivo principal.');
    const imported=JSON.parse(data.state);
    if(!imported.v)throw new Error('Dados inv\u00e1lidos');
    S=imported;
    // ensure all fields
    ['vfAmts','payments','debtMo','transfers'].forEach(k=>{if(!S[k])S[k]={};});
    ['debtPays','gastos','caixinha','debts','entries'].forEach(k=>{if(!S[k])S[k]=[];});
    ['nextEId','nextDId','nextDPId','nextGId','nextCId'].forEach(k=>{if(!S[k])S[k]=1;});
    persist();render();
    setSyncStatus('\u2705 Dados importados com sucesso!','var(--ok)');
  }catch(err){
    setSyncStatus('\u274C '+err.message,'var(--err)');
  }
}


// ─── RELATÓRIO CLAUDE ───
function openReport(){
  const txt = buildReport();
  document.getElementById('reportTxt').value = txt;
  document.getElementById('reportCopied').textContent = '';
  openM('mReport');
}

function copyReport(){
  const ta = document.getElementById('reportTxt');
  ta.select();
  ta.setSelectionRange(0, 99999);
  try {
    navigator.clipboard.writeText(ta.value).then(()=>{
      document.getElementById('reportCopied').textContent = '✓ Copiado! Agora cole numa conversa com o Claude.';
    }).catch(()=>{ document.execCommand('copy'); document.getElementById('reportCopied').textContent = '✓ Copiado!'; });
  } catch(e) {
    document.execCommand('copy');
    document.getElementById('reportCopied').textContent = '✓ Copiado!';
  }
}

function buildReport(){
  const now = new Date();
  const lines = [];
  const h = (t) => lines.push('\n' + '═'.repeat(48) + '\n' + t + '\n' + '═'.repeat(48));
  const s = (t) => lines.push('\n── ' + t + ' ──');
  const l = (t) => lines.push(t);

  lines.push('RELATÓRIO FINANCEIRO COMPLETO — MEU CAIXA');
  lines.push('Gerado em: ' + now.toLocaleDateString('pt-BR') + ' às ' + now.toLocaleTimeString('pt-BR'));
  lines.push('Referência: ' + MS[curM] + '/' + curY);

  // ── VISÃO GERAL DO MÊS ──
  h('VISÃO GERAL — ' + MS[curM].toUpperCase() + ' ' + curY);
  const c5 = calcPeriod(5), c20 = calcPeriod(20);
  const tr = S.transfers[trK()] || 0;
  const gasT = S.gastos.filter(g=>g.y===curY&&g.m===curM).reduce((s,g)=>s+g.amt,0);
  const cxBal = S.caixinha.reduce((s,t)=>s+(t.type==='in'?t.amt:-t.amt),0);
  const dRest = S.debts.reduce((s,d)=>s+debtRem(d),0);

  l('Salários Dia 05:    ' + fmt(c5.totalIn));
  l('Salários Dia 20:    ' + fmt(c20.totalIn));
  l('Total Receitas:     ' + fmt(c5.totalIn + c20.totalIn));
  l('Transferência D05→D20: ' + fmt(tr));
  l('');
  l('Despesas Dia 05:    ' + fmt(c5.totalOut));
  l('Despesas Dia 20:    ' + fmt(c20.totalOut));
  l('Total Despesas:     ' + fmt(c5.totalOut + c20.totalOut));
  l('');
  l('Saldo Dia 05:       ' + fmt(c5.bal) + (c5.bal < 0 ? ' ⚠️ NEGATIVO' : ' ✓'));
  l('Saldo Dia 20:       ' + fmt(c20.bal) + (c20.bal < 0 ? ' ⚠️ NEGATIVO' : ' ✓'));
  l('');
  l('Gastos Dia a Dia:   ' + fmt(gasT));
  l('Caixinha (saldo):   ' + fmt(cxBal));
  l('Dívidas em aberto:  ' + fmt(dRest));
  l('');
  l('Contas pagas D05:   ' + c5.pC + '/' + c5.tC);
  l('Contas pagas D20:   ' + c20.pC + '/' + c20.tC);

  // ── DIA 05 ──
  h('PLANO DIA 05');
  const ents5 = periodEntries(5);
  const inc5 = ents5.filter(e=>e.type==='income');
  const exp5 = ents5.filter(e=>e.type!=='income');
  s('Entradas');
  inc5.forEach(e => l('  + ' + e.name.padEnd(22) + fmt(planned(e))));
  s('Despesas Fixas / Variáveis');
  exp5.forEach(e => {
    const pg = isPaid(e.pid);
    const val = planned(e);
    const pa = paidAmt(e.pid);
    const status = pg ? ('✓ pago ' + fmt(pa) + (pa !== val ? ' (plan. '+fmt(val)+')' : '')) : '○ pendente';
    l('  ' + (pg?'✓':'○') + ' ' + e.name.padEnd(22) + fmt(val) + '  ' + status.replace(fmt(pa),'').replace('✓ pago','').trim());
  });

  // ── DIA 20 ──
  h('PLANO DIA 20');
  const ents20 = periodEntries(20);
  const inc20 = ents20.filter(e=>e.type==='income');
  const exp20 = ents20.filter(e=>e.type!=='income');
  s('Entradas');
  inc20.forEach(e => l('  + ' + e.name.padEnd(22) + fmt(planned(e))));
  if(tr > 0) l('  + Recebido do Dia 05     ' + fmt(tr));
  s('Despesas Fixas / Variáveis');
  exp20.forEach(e => {
    const pg = isPaid(e.pid);
    const val = planned(e);
    const pa = paidAmt(e.pid);
    l('  ' + (pg?'✓':'○') + ' ' + e.name.padEnd(22) + fmt(val) + (pg ? '  ✓ pago '+fmt(pa) : '  ○ pendente'));
  });

  // ── DÍVIDAS ──
  h('DÍVIDAS');
  if(S.debts.length === 0){
    l('Nenhuma dívida cadastrada. 🎉');
  } else {
    S.debts.forEach(d => {
      const rest = debtRem(d);
      const paid = debtPaidTotal(d);
      const pct = d.total > 0 ? Math.round(paid/d.total*100) : 0;
      const done = rest <= 0;
      l('');
      l((done?'✓ QUITADA':'● ATIVA') + ' — ' + d.name + (d.who?' ('+d.who+')':''));
      l('  Tipo:      ' + (d.kind==='parc'?'Parcelada':'Em aberto'));
      l('  Total:     ' + fmt(d.total));
      l('  Pago:      ' + fmt(paid) + ' (' + pct + '%)');
      l('  Restante:  ' + fmt(rest));
      l('  Parcela:   ' + fmt(d.monthly) + '/mês — Dia ' + String(d.day).padStart(2,'0'));
      l('  Período:   ' + MS[d.startM]+'/'+d.startY + (d.endM!=null&&d.endY?' → '+MS[d.endM]+'/'+d.endY:''));
      if(d.note) l('  Obs:       ' + d.note);
      const mPago = !!(S.debtMo[dpK(d.id)]);
      l('  Este mês:  ' + (mPago ? '✓ parcela paga' : '○ parcela pendente'));
    });
    l('');
    l('TOTAL EM DÍVIDAS: ' + fmt(dRest));
  }

  // ── GASTOS DO MÊS ──
  h('GASTOS DO DIA A DIA — ' + MS[curM].toUpperCase() + ' ' + curY);
  const gs = S.gastos.filter(g=>g.y===curY&&g.m===curM);
  if(gs.length === 0){
    l('Nenhum gasto lançado neste mês.');
  } else {
    const byCat = {};
    gs.forEach(g=>{ if(!byCat[g.cat]) byCat[g.cat]=0; byCat[g.cat]+=g.amt; });
    s('Por categoria');
    Object.entries(byCat).sort((a,b)=>b[1]-a[1]).forEach(([cat,amt])=>{
      const pct = gasT > 0 ? Math.round(amt/gasT*100) : 0;
      l('  ' + cat.padEnd(24) + fmt(amt) + '  (' + pct + '%)');
    });
    s('Lançamentos');
    [...gs].reverse().forEach(g => {
      l('  ' + fdate(g.date) + '  ' + g.desc.padEnd(22) + fmt(g.amt) + '  ' + g.cat.substring(2));
    });
    l('');
    l('TOTAL GASTOS: ' + fmt(gasT));
  }

  // ── CAIXINHA ──
  h('CAIXINHA (POUPANÇA)');
  l('Saldo atual: ' + fmt(cxBal));
  l('');
  const cxMes = S.caixinha.filter(t=>t.y===curY&&t.m===curM);
  if(cxMes.length > 0){
    s('Movimentações de ' + MS[curM]);
    cxMes.forEach(t => l('  ' + (t.type==='in'?'+':'-') + ' ' + fmt(t.amt) + '  ' + t.desc + '  (' + fdate(t.date) + ')'));
  }
  if(S.caixinha.length > cxMes.length){
    s('Histórico geral');
    [...S.caixinha].reverse().slice(0,20).forEach(t => l('  ' + MS[t.m]+'/'+t.y + '  ' + (t.type==='in'?'+':'-') + fmt(t.amt) + '  ' + t.desc));
  }

  // ── HISTÓRICO DE MESES ANTERIORES ──
  h('HISTÓRICO MESES ANTERIORES');
  // find unique months in gastos (last 6)
  const monthsSet = new Set();
  S.gastos.forEach(g => monthsSet.add(g.y+'-'+String(g.m).padStart(2,'0')));
  const months = [...monthsSet].sort().reverse().slice(0,6);
  months.forEach(mk => {
    const [my, mm] = mk.split('-').map(Number);
    if(my===curY && mm===curM) return; // skip current
    const mGs = S.gastos.filter(g=>g.y===my&&g.m===mm);
    const mTotal = mGs.reduce((s,g)=>s+g.amt,0);
    l(MS[mm]+'/'+my + ' — Gastos: ' + fmt(mTotal) + ' (' + mGs.length + ' lançamentos)');
  });

  // ── ANÁLISE / CONTEXTO ──
  h('CONTEXTO PARA ANÁLISE');
  const totalRec = c5.totalIn + c20.totalIn;
  const totalDesp = c5.totalOut + c20.totalOut;
  const sobra = c20.bal;
  const compDesp = totalDesp > 0 ? Math.round(totalDesp/totalRec*100) : 0;
  const compDiv = totalRec > 0 ? Math.round(dRest/totalRec*100) : 0;
  l('Receita total:        ' + fmt(totalRec));
  l('Despesas fixas total: ' + fmt(totalDesp) + ' (' + compDesp + '% da receita)');
  l('Sobra do mês:         ' + fmt(sobra));
  l('Gastos variáveis:     ' + fmt(gasT));
  l('Dívidas = ' + compDiv + 'x o salário mensal');
  l('');
  l('--- FIM DO RELATÓRIO ---');
  l('Cole este texto numa conversa com o Claude para análise e planejamento.');

  return lines.join('\n');
}

// ─── RENDER ───
function render(){
  const n=new Date(),isNow=(curM===n.getMonth()&&curY===n.getFullYear());
  const lbl=document.getElementById('mlbl');lbl.textContent=MS[curM]+' '+curY;lbl.className='mlbl'+(isNow?' now':'');
  if(curPage==='plano')renderPlano();
  else if(curPage==='dividas')renderDividas();
  else if(curPage==='gastos')renderGastos();
  else if(curPage==='caixinha')renderCaixinha();
  else if(curPage==='dash')renderDash();
}

// ─── INIT ───
load();
document.getElementById('cfgUrl').value=localStorage.getItem('cfg_url')||'';
render();
</script>

<div class="mbg" id="mReport"><div class="modal" style="padding-bottom:32px">
  <div class="mhandle"></div>
  <div class="mtitle">&#x1F4CB; Relat&#243;rio para Claude</div>
  <div class="ibox" style="margin-bottom:10px;line-height:1.7">
    Copie tudo abaixo e cole numa conversa comigo (Claude) para an&#225;lise completa da sua vida financeira.
  </div>
  <textarea id="reportTxt" readonly style="width:100%;height:240px;background:var(--bg);border:1.5px solid var(--bd);border-radius:9px;color:var(--tx);font-family:var(--fm);font-size:10px;padding:10px;line-height:1.6;resize:none;outline:none"></textarea>
  <button class="btn-save" style="margin-top:10px" onclick="copyReport()">&#x1F4CB; Copiar Tudo</button>
  <div id="reportCopied" style="text-align:center;font-size:11px;color:var(--ok);margin-top:6px;min-height:16px"></div>
  <button class="btn-cancel" onclick="closeM('mReport')">Fechar</button>
</div></div>
</body>
</html>
